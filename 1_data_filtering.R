# Arc-well - filtering datasets
#---Note: run mapping and segmention scripts before running this-----#######
#---mapping and segmentation scripts in https://github.com/navinlabcode/CNV_pipeline
#---This script needs input files from ./final_result/ folder and ./metrics folder generated by above CNA_pipeline: 
# uber.*.bin.txt 
# uber.*.ratio.txt 
# uber.*.seg.txt 
# all_stat_metrics.txt

#####-------loading packages-----------################
library(copykit)
library(tidyverse)
library(stringr)
library(dplyr)
library(tidyr)
library(cowplot)
library(useful)
library(tibble)
library(SummarizedExperiment)
options(max.print = 200)

setwd("/volumes/USR2/wangkl/wscDR/wdr_analysis")
load("./pre_load_data/pre_load_data.rda")
source("./scripts/0_wdr_functions.R")
bin_coords <- read.csv("./pre_load_data/bin_coords.csv")
#---WDR-nanowell1-mda231----####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20211029_WDR_MDA231_chip1R_chip2DR-noNT_SpRNA-ECIS44-cDNA2/data/waferDR_MDA231_chip1_DNA_1M/waferDR_MDA231_chip1-DNA-1M_200/res_200_k")
met_path <- c("./map_seg_output/wdr_nanowell1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

wdr_nanowell1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

wdr_nanowell1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
wdr_nanowell1 <- filterCells(wdr_nanowell1, resolution = 0.8)

wdr_nanowell1_metadata <- as.data.frame(colData(wdr_nanowell1))
wdr_nanowell1_metadata_metrics <- left_join(wdr_nanowell1_metadata, wdr_nanowell1_metrics)
write.table(wdr_nanowell1_metadata_metrics,"./metrics/wdr_nanowell1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/wdr_nanowell1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(wdr_nanowell1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


wdr_nanowell1 <- wdr_nanowell1[,SummarizedExperiment::colData(wdr_nanowell1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(wdr_nanowell1,'bin_counts')), 
            "./metrics/wdr_nanowell1_filtered_bincounts.txt",row.names = F)





#---WDR-nanowell2-mda231----####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20210821_WDR_lowdNTP_231DR_ART216orgR_SpRNA-ECIS42-SnubarARC-RNA2/data/waferDR_231_DNA_1M/waferDR_231_DNA_1M_200/res_200_k")
met_path <- c("./map_seg_output/wdr_nanowell2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

wdr_nanowell2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

wdr_nanowell2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
wdr_nanowell2 <- filterCells(wdr_nanowell2, resolution = 0.8)

wdr_nanowell2_metadata <- as.data.frame(colData(wdr_nanowell2))
wdr_nanowell2_metadata_metrics <- left_join(wdr_nanowell2_metadata, wdr_nanowell2_metrics)
write.table(wdr_nanowell2_metadata_metrics,"./metrics/wdr_nanowell2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/wdr_nanowell2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(wdr_nanowell2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


wdr_nanowell2 <- wdr_nanowell2[,SummarizedExperiment::colData(wdr_nanowell2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(wdr_nanowell2,'bin_counts')), 
            "./metrics/wdr_nanowell2_filtered_bincounts.txt",row.names = F)





######---- Arc-well-mda231 -----########
#-folder contains ./final_result and ./metrics
met_path0 <- c("/volumes/USR2/wangkl/wafergen/DNA/ffpe_dcis/github_upload2/map_seg_output/arc_well_mda231")
met_path <- c("./map_seg_output/arc_well")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

arc_well_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

arc_well <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
arc_well <- filterCells(arc_well, resolution = 0.8)

arc_well_metadata <- as.data.frame(colData(arc_well))
arc_well_metadata_metrics <- left_join(arc_well_metadata, arc_well_metrics)
write.table(arc_well_metadata_metrics,"./metrics/arc_well_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

arc_well <- arc_well[,SummarizedExperiment::colData(arc_well)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(arc_well,'bin_counts')), 
            "./metrics/arc_well_filtered_bincounts.txt",row.names = F)

# 10X genomics Tn17 ----
met_path0 <- c("/volumes/USR2/wangkl/wafergen/DNA/ffpe_dcis/github_upload2/map_seg_output/tenx")
met_path <- c("./map_seg_output/tenx")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

tenx_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
tenx <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)

tenx <- filterCells(tenx, resolution = 0.8)
tenx_metadata <- as.data.frame(colData(tenx))
tenx_metadata_metrics <- left_join(tenx_metadata, tenx_metrics)
write.table(tenx_metadata_metrics,"./metrics/tenx_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

tenx <- tenx[,SummarizedExperiment::colData(tenx)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(tenx,'bin_counts')), "./metrics/tenx_filtered_bincounts.txt",row.names = F)


# DOP-PCR-merged----
met_path0 <- c("/volumes/USR2/wangkl/wafergen/DNA/ffpe_dcis/github_upload2/map_seg_output/dop_merge")
met_path <- c("./map_seg_output/dop_merge")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

dop_merge_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

dop_merge <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
dop_merge <- filterCells(dop_merge, resolution = 0.8)

dop_merge_metadata <- as.data.frame(colData(dop_merge))
# joining with metrics
dop_merge_metadata_metrics <- left_join(dop_merge_metadata, dop_merge_metrics)
write.table(dop_merge_metadata_metrics,"./metrics/dop_merge_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

dop_merge <- dop_merge[,SummarizedExperiment::colData(dop_merge)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(dop_merge,'bin_counts')), "./metrics/dop_merge_filtered_bincounts.txt",row.names = F)

# DLP+ ----
met_path0 <- c("/volumes/USR2/wangkl/wafergen/DNA/ffpe_dcis/github_upload2/map_seg_output/dlp_plus")
met_path <- c("./map_seg_output/dlp_plus")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

dlp_plus_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

dlp_plus <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
dlp_plus <- filterCells(dlp_plus, resolution = 0.8)

dlp_plus_metadata <- as.data.frame(colData(dlp_plus))

# joining with metrics
dlp_plus_metadata_metrics <- left_join(dlp_plus_metadata, dlp_plus_metrics)
write.table(dlp_plus_metadata_metrics,"./metrics/dlp_plus_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

dlp_plus <- dlp_plus[,SummarizedExperiment::colData(dlp_plus)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(dlp_plus,'bin_counts')), "./metrics/dlp_plus_filtered_bincounts.txt",row.names = F)



#######---0.7---####
#----ECIS36T-chip1-----#####
met_path <- c("./map_seg_output/ecis36t_chip1")
ecis36t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip1test <- findNormalCell(ecis36t_chip1)

# my_normal <- ecis36t_chip1test@colData %>% as.data.frame() %>% dplyr::filter(is_normal)
# write.csv(my_normal, "./metrics/ecis36t_chip1_non_aneuplod_cells2.csv", row.names = F)
# my_normal2 <- read.csv("./metrics/ecis36t_chip1_non_aneuplod_cells2.csv")

pdf("./figures/ecis36t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis36t_chip1test1 <- ecis36t_chip1test[, ecis36t_chip1test@colData$is_normal == "TRUE"]
ecis36t_chip1test2 <- ecis36t_chip1test[, ecis36t_chip1test@colData$is_normal == "FALSE"]

ecis36t_chip1test2 <- filterCells(ecis36t_chip1test2, resolution = 0.7)
plotHeatmap(ecis36t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis36t_chip1test2 <- ecis36t_chip1test2[,ecis36t_chip1test2@colData$filtered == "kept"]
ecis36t_chip1test1@colData$filter_corr_value <- 0
ecis36t_chip1test1@colData$filtered <- "kept"
ecis36t_chip1test1@colData$filter_cell <- "diploid"
ecis36t_chip1test2@colData$filter_cell <- "aneuploid"
ecis36t_chip1 <- cbind(ecis36t_chip1test1, ecis36t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip1,'bin_counts')), 
            "./metrics/ecis36t_chip1_filtered_bincounts2.txt",row.names = F)




#----ECIS36T-chip2-----#####
met_path <- c("./map_seg_output/ecis36t_chip2")
ecis36t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip2test <- findNormalCell(ecis36t_chip2)

pdf("./figures/ecis36t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis36t_chip2test1 <- ecis36t_chip2test[, ecis36t_chip2test@colData$is_normal == "TRUE"]
ecis36t_chip2test2 <- ecis36t_chip2test[, ecis36t_chip2test@colData$is_normal == "FALSE"]

ecis36t_chip2test2 <- filterCells(ecis36t_chip2test2, resolution = 0.7)
plotHeatmap(ecis36t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis36t_chip2test2 <- ecis36t_chip2test2[,ecis36t_chip2test2@colData$filtered == "kept"]
ecis36t_chip2test1@colData$filter_corr_value <- 0
ecis36t_chip2test1@colData$filtered <- "kept"
ecis36t_chip2test1@colData$filter_cell <- "diploid"
ecis36t_chip2test2@colData$filter_cell <- "aneuploid"
ecis36t_chip2 <- cbind(ecis36t_chip2test1, ecis36t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip2,'bin_counts')), 
            "./metrics/ecis36t_chip2_filtered_bincounts2.txt",row.names = F)




#----ecis25T-chip1-----#####
met_path <- c("./map_seg_output/ecis25t_chip1")
ecis25t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip1test <- findNormalCell(ecis25t_chip1)

pdf("./figures/ecis25t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip1test1 <- ecis25t_chip1test[, ecis25t_chip1test@colData$is_normal == "TRUE"]
ecis25t_chip1test2 <- ecis25t_chip1test[, ecis25t_chip1test@colData$is_normal == "FALSE"]

ecis25t_chip1test2 <- filterCells(ecis25t_chip1test2, resolution = 0.7)
plotHeatmap(ecis25t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip1test2 <- ecis25t_chip1test2[,ecis25t_chip1test2@colData$filtered == "kept"]
ecis25t_chip1test1@colData$filter_corr_value <- 0
ecis25t_chip1test1@colData$filtered <- "kept"
ecis25t_chip1test1@colData$filter_cell <- "diploid"
ecis25t_chip1test2@colData$filter_cell <- "aneuploid"
ecis25t_chip1 <- cbind(ecis25t_chip1test1, ecis25t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip1,'bin_counts')), 
            "./metrics/ecis25t_chip1_filtered_bincounts2.txt",row.names = F)




#----ecis25T-chip2-----#####
met_path <- c("./map_seg_output/ecis25t_chip2")
ecis25t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip2test <- findNormalCell(ecis25t_chip2)

pdf("./figures/ecis25t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip2test1 <- ecis25t_chip2test[, ecis25t_chip2test@colData$is_normal == "TRUE"]
ecis25t_chip2test2 <- ecis25t_chip2test[, ecis25t_chip2test@colData$is_normal == "FALSE"]

ecis25t_chip2test2 <- filterCells(ecis25t_chip2test2, resolution = 0.7)
plotHeatmap(ecis25t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip2test2 <- ecis25t_chip2test2[,ecis25t_chip2test2@colData$filtered == "kept"]
ecis25t_chip2test1@colData$filter_corr_value <- 0
ecis25t_chip2test1@colData$filtered <- "kept"
ecis25t_chip2test1@colData$filter_cell <- "diploid"
ecis25t_chip2test2@colData$filter_cell <- "aneuploid"
ecis25t_chip2 <- cbind(ecis25t_chip2test1, ecis25t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip2,'bin_counts')), 
            "./metrics/ecis25t_chip2_filtered_bincounts2.txt",row.names = F)


#----ecis25T-chip3-----#####
met_path <- c("./map_seg_output/ecis25t_chip3")
ecis25t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip3test <- findNormalCell(ecis25t_chip3)

pdf("./figures/ecis25t_chip3_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip3test1 <- ecis25t_chip3test[, ecis25t_chip3test@colData$is_normal == "TRUE"]
ecis25t_chip3test2 <- ecis25t_chip3test[, ecis25t_chip3test@colData$is_normal == "FALSE"]

ecis25t_chip3test2 <- filterCells(ecis25t_chip3test2, resolution = 0.7)
plotHeatmap(ecis25t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip3test2 <- ecis25t_chip3test2[,ecis25t_chip3test2@colData$filtered == "kept"]
ecis25t_chip3test1@colData$filter_corr_value <- 0
ecis25t_chip3test1@colData$filtered <- "kept"
ecis25t_chip3test1@colData$filter_cell <- "diploid"
ecis25t_chip3test2@colData$filter_cell <- "aneuploid"
ecis25t_chip3 <- cbind(ecis25t_chip3test1, ecis25t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip3,'bin_counts')), 
            "./metrics/ecis25t_chip3_filtered_bincounts2.txt",row.names = F)































#----bcis13T-chip1-----#####
met_path <- c("./map_seg_output/bcis13t_chip1")
bcis13t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis13t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip1test <- findNormalCell(bcis13t_chip1)

pdf("./figures/bcis13t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis13t_chip1test1 <- bcis13t_chip1test[, bcis13t_chip1test@colData$is_normal == "TRUE"]
bcis13t_chip1test2 <- bcis13t_chip1test[, bcis13t_chip1test@colData$is_normal == "FALSE"]

bcis13t_chip1test2 <- filterCells(bcis13t_chip1test2, resolution = 0.7)
plotHeatmap(bcis13t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis13t_chip1test2 <- bcis13t_chip1test2[,bcis13t_chip1test2@colData$filtered == "kept"]
bcis13t_chip1test1@colData$filter_corr_value <- 0
bcis13t_chip1test1@colData$filtered <- "kept"
bcis13t_chip1test1@colData$filter_cell <- "diploid"
bcis13t_chip1test2@colData$filter_cell <- "aneuploid"
bcis13t_chip1 <- cbind(bcis13t_chip1test1, bcis13t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip1,'bin_counts')), 
            "./metrics/bcis13t_chip1_filtered_bincounts2.txt",row.names = F)




#----bcis13T-chip2-----#####
met_path <- c("./map_seg_output/bcis13t_chip2")
bcis13t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis13t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip2test <- findNormalCell(bcis13t_chip2)

pdf("./figures/bcis13t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis13t_chip2test1 <- bcis13t_chip2test[, bcis13t_chip2test@colData$is_normal == "TRUE"]
bcis13t_chip2test2 <- bcis13t_chip2test[, bcis13t_chip2test@colData$is_normal == "FALSE"]

bcis13t_chip2test2 <- filterCells(bcis13t_chip2test2, resolution = 0.7)
plotHeatmap(bcis13t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis13t_chip2test2 <- bcis13t_chip2test2[,bcis13t_chip2test2@colData$filtered == "kept"]
bcis13t_chip2test1@colData$filter_corr_value <- 0
bcis13t_chip2test1@colData$filtered <- "kept"
bcis13t_chip2test1@colData$filter_cell <- "diploid"
bcis13t_chip2test2@colData$filter_cell <- "aneuploid"
bcis13t_chip2 <- cbind(bcis13t_chip2test1, bcis13t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip2,'bin_counts')), 
            "./metrics/bcis13t_chip2_filtered_bincounts2.txt",row.names = F)





#----ecis44T-chip1-----#####
met_path <- c("./map_seg_output/ecis44t_chip1")
ecis44t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip1test <- findNormalCell(ecis44t_chip1)

pdf("./figures/ecis44t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip1test1 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "TRUE"]
ecis44t_chip1test2 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "FALSE"]

ecis44t_chip1test2 <- filterCells(ecis44t_chip1test2, resolution = 0.7)
plotHeatmap(ecis44t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip1test2 <- ecis44t_chip1test2[,ecis44t_chip1test2@colData$filtered == "kept"]
ecis44t_chip1test1@colData$filter_corr_value <- 0
ecis44t_chip1test1@colData$filtered <- "kept"
ecis44t_chip1test1@colData$filter_cell <- "diploid"
ecis44t_chip1test2@colData$filter_cell <- "aneuploid"
ecis44t_chip1 <- cbind(ecis44t_chip1test1, ecis44t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip1,'bin_counts')), 
            "./metrics/ecis44t_chip1_filtered_bincounts2.txt",row.names = F)




#----ecis44T-chip2-----#####
met_path <- c("./map_seg_output/ecis44t_chip2")
ecis44t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip2test <- findNormalCell(ecis44t_chip2)

pdf("./figures/ecis44t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip2test1 <- ecis44t_chip2test[, ecis44t_chip2test@colData$is_normal == "TRUE"]
ecis44t_chip2test2 <- ecis44t_chip2test[, ecis44t_chip2test@colData$is_normal == "FALSE"]

ecis44t_chip2test2 <- filterCells(ecis44t_chip2test2, resolution = 0.7)
plotHeatmap(ecis44t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip2test2 <- ecis44t_chip2test2[,ecis44t_chip2test2@colData$filtered == "kept"]
ecis44t_chip2test1@colData$filter_corr_value <- 0
ecis44t_chip2test1@colData$filtered <- "kept"
ecis44t_chip2test1@colData$filter_cell <- "diploid"
ecis44t_chip2test2@colData$filter_cell <- "aneuploid"
ecis44t_chip2 <- cbind(ecis44t_chip2test1, ecis44t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip2,'bin_counts')), 
            "./metrics/ecis44t_chip2_filtered_bincounts2.txt",row.names = F)


#----ecis44T-chip3-----#####
met_path <- c("./map_seg_output/ecis44t_chip3")
ecis44t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip3test <- findNormalCell(ecis44t_chip3)

pdf("./figures/ecis44t_chip3_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip3test1 <- ecis44t_chip3test[, ecis44t_chip3test@colData$is_normal == "TRUE"]
ecis44t_chip3test2 <- ecis44t_chip3test[, ecis44t_chip3test@colData$is_normal == "FALSE"]

ecis44t_chip3test2 <- filterCells(ecis44t_chip3test2, resolution = 0.7)
plotHeatmap(ecis44t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip3test2 <- ecis44t_chip3test2[,ecis44t_chip3test2@colData$filtered == "kept"]
ecis44t_chip3test1@colData$filter_corr_value <- 0
ecis44t_chip3test1@colData$filtered <- "kept"
ecis44t_chip3test1@colData$filter_cell <- "diploid"
ecis44t_chip3test2@colData$filter_cell <- "aneuploid"
ecis44t_chip3 <- cbind(ecis44t_chip3test1, ecis44t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip3,'bin_counts')), 
            "./metrics/ecis44t_chip3_filtered_bincounts2.txt",row.names = F)

































# #----ecis44T-chip4-----#####
# met_path <- c("./map_seg_output/ecis44t_chip4")
# ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
#   dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
# ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
# ecis44t_chip4test <- findNormalCell(ecis44t_chip4)
# 
# pdf("./figures/ecis44t_chip4_filtered_heatmap2.pdf", height = 8, width = 6)
# plotHeatmap(ecis44t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
#               list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)
# 
# ecis44t_chip4test1 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "TRUE"]
# ecis44t_chip4test2 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "FALSE"]
# 
# ecis44t_chip4test2 <- filterCells(ecis44t_chip4test2, resolution = 0.7)
# plotHeatmap(ecis44t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
#               list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
# dev.off()
# 
# ecis44t_chip4test2 <- ecis44t_chip4test2[,ecis44t_chip4test2@colData$filtered == "kept"]
# ecis44t_chip4test1@colData$filter_corr_value <- 0
# ecis44t_chip4test1@colData$filtered <- "kept"
# ecis44t_chip4test1@colData$filter_cell <- "diploid"
# ecis44t_chip4test2@colData$filter_cell <- "aneuploid"
# ecis44t_chip4 <- cbind(ecis44t_chip4test1, ecis44t_chip4test2)
# 
# bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
# write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
#             "./metrics/ecis44t_chip4_filtered_bincounts2.txt",row.names = F)
# 
# 

#----ecis44T-chip5-----#####
met_path <- c("./map_seg_output/ecis44t_chip5")
ecis44t_chip5_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip5 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip5test <- findNormalCell(ecis44t_chip5)

pdf("./figures/ecis44t_chip5_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip5test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip5test1 <- ecis44t_chip5test[, ecis44t_chip5test@colData$is_normal == "TRUE"]
ecis44t_chip5test2 <- ecis44t_chip5test[, ecis44t_chip5test@colData$is_normal == "FALSE"]

ecis44t_chip5test2 <- filterCells(ecis44t_chip5test2, resolution = 0.7)
plotHeatmap(ecis44t_chip5test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip5test2 <- ecis44t_chip5test2[,ecis44t_chip5test2@colData$filtered == "kept"]
ecis44t_chip5test1@colData$filter_corr_value <- 0
ecis44t_chip5test1@colData$filtered <- "kept"
ecis44t_chip5test1@colData$filter_cell <- "diploid"
ecis44t_chip5test2@colData$filter_cell <- "aneuploid"
ecis44t_chip5 <- cbind(ecis44t_chip5test1, ecis44t_chip5test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip5,'bin_counts')), 
            "./metrics/ecis44t_chip5_filtered_bincounts2.txt",row.names = F)



#----ecis44T-chip4-----#####
met_path <- c("./map_seg_output/ecis44t_chip4")
ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip4test <- findNormalCell(ecis44t_chip4)

pdf("./figures/ecis44t_chip4_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip4test1 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "TRUE"]
ecis44t_chip4test2 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "FALSE"]

ecis44t_chip4test2 <- filterCells(ecis44t_chip4test2, resolution = 0.7)
plotHeatmap(ecis44t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip4test2 <- ecis44t_chip4test2[,ecis44t_chip4test2@colData$filtered == "kept"]
ecis44t_chip4test1@colData$filter_corr_value <- 0
ecis44t_chip4test1@colData$filtered <- "kept"
ecis44t_chip4test1@colData$filter_cell <- "diploid"
ecis44t_chip4test2@colData$filter_cell <- "aneuploid"
ecis44t_chip4 <- cbind(ecis44t_chip4test1, ecis44t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
            "./metrics/ecis44t_chip4_filtered_bincounts2.txt",row.names = F)






#----bcis19T-chip1-----#####
met_path <- c("./map_seg_output/bcis19t_chip1")
bcis19t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip1test <- findNormalCell(bcis19t_chip1)

pdf("./figures/bcis19t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip1test1 <- bcis19t_chip1test[, bcis19t_chip1test@colData$is_normal == "TRUE"]
bcis19t_chip1test2 <- bcis19t_chip1test[, bcis19t_chip1test@colData$is_normal == "FALSE"]

bcis19t_chip1test2 <- filterCells(bcis19t_chip1test2, resolution = 0.7)
plotHeatmap(bcis19t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip1test2 <- bcis19t_chip1test2[,bcis19t_chip1test2@colData$filtered == "kept"]
bcis19t_chip1test1@colData$filter_corr_value <- 0
bcis19t_chip1test1@colData$filtered <- "kept"
bcis19t_chip1test1@colData$filter_cell <- "diploid"
bcis19t_chip1test2@colData$filter_cell <- "aneuploid"
bcis19t_chip1 <- cbind(bcis19t_chip1test1, bcis19t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip1,'bin_counts')), 
            "./metrics/bcis19t_chip1_filtered_bincounts2.txt",row.names = F)




#----bcis19T-chip2-----#####
met_path <- c("./map_seg_output/bcis19t_chip2")
bcis19t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip2test <- findNormalCell(bcis19t_chip2)

pdf("./figures/bcis19t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip2test1 <- bcis19t_chip2test[, bcis19t_chip2test@colData$is_normal == "TRUE"]
bcis19t_chip2test2 <- bcis19t_chip2test[, bcis19t_chip2test@colData$is_normal == "FALSE"]

bcis19t_chip2test2 <- filterCells(bcis19t_chip2test2, resolution = 0.7)
plotHeatmap(bcis19t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip2test2 <- bcis19t_chip2test2[,bcis19t_chip2test2@colData$filtered == "kept"]
bcis19t_chip2test1@colData$filter_corr_value <- 0
bcis19t_chip2test1@colData$filtered <- "kept"
bcis19t_chip2test1@colData$filter_cell <- "diploid"
bcis19t_chip2test2@colData$filter_cell <- "aneuploid"
bcis19t_chip2 <- cbind(bcis19t_chip2test1, bcis19t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip2,'bin_counts')), 
            "./metrics/bcis19t_chip2_filtered_bincounts2.txt",row.names = F)


#----bcis19T-chip3-----#####
met_path <- c("./map_seg_output/bcis19t_chip3")
bcis19t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip3test <- findNormalCell(bcis19t_chip3)

pdf("./figures/bcis19t_chip3_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip3test1 <- bcis19t_chip3test[, bcis19t_chip3test@colData$is_normal == "TRUE"]
bcis19t_chip3test2 <- bcis19t_chip3test[, bcis19t_chip3test@colData$is_normal == "FALSE"]

bcis19t_chip3test2 <- filterCells(bcis19t_chip3test2, resolution = 0.7)
plotHeatmap(bcis19t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip3test2 <- bcis19t_chip3test2[,bcis19t_chip3test2@colData$filtered == "kept"]
bcis19t_chip3test1@colData$filter_corr_value <- 0
bcis19t_chip3test1@colData$filtered <- "kept"
bcis19t_chip3test1@colData$filter_cell <- "diploid"
bcis19t_chip3test2@colData$filter_cell <- "aneuploid"
bcis19t_chip3 <- cbind(bcis19t_chip3test1, bcis19t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip3,'bin_counts')), 
            "./metrics/bcis19t_chip3_filtered_bincounts2.txt",row.names = F)

































#----bcis19T-chip4-----#####
met_path <- c("./map_seg_output/bcis19t_chip4")
bcis19t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip4test <- findNormalCell(bcis19t_chip4)

pdf("./figures/bcis19t_chip4_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip4test1 <- bcis19t_chip4test[, bcis19t_chip4test@colData$is_normal == "TRUE"]
bcis19t_chip4test2 <- bcis19t_chip4test[, bcis19t_chip4test@colData$is_normal == "FALSE"]

bcis19t_chip4test2 <- filterCells(bcis19t_chip4test2, resolution = 0.7)
plotHeatmap(bcis19t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip4test2 <- bcis19t_chip4test2[,bcis19t_chip4test2@colData$filtered == "kept"]
bcis19t_chip4test1@colData$filter_corr_value <- 0
bcis19t_chip4test1@colData$filtered <- "kept"
bcis19t_chip4test1@colData$filter_cell <- "diploid"
bcis19t_chip4test2@colData$filter_cell <- "aneuploid"
bcis19t_chip4 <- cbind(bcis19t_chip4test1, bcis19t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip4,'bin_counts')), 
            "./metrics/bcis19t_chip4_filtered_bincounts2.txt",row.names = F)





#----bcis28T-chip1-----#####
met_path <- c("./map_seg_output/bcis28t_chip1")
bcis28t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip1test <- findNormalCell(bcis28t_chip1)

pdf("./figures/bcis28t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip1test1 <- bcis28t_chip1test[, bcis28t_chip1test@colData$is_normal == "TRUE"]
bcis28t_chip1test2 <- bcis28t_chip1test[, bcis28t_chip1test@colData$is_normal == "FALSE"]

bcis28t_chip1test2 <- filterCells(bcis28t_chip1test2, resolution = 0.7)
plotHeatmap(bcis28t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip1test2 <- bcis28t_chip1test2[,bcis28t_chip1test2@colData$filtered == "kept"]
bcis28t_chip1test1@colData$filter_corr_value <- 0
bcis28t_chip1test1@colData$filtered <- "kept"
bcis28t_chip1test1@colData$filter_cell <- "diploid"
bcis28t_chip1test2@colData$filter_cell <- "aneuploid"
bcis28t_chip1 <- cbind(bcis28t_chip1test1, bcis28t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip1,'bin_counts')), 
            "./metrics/bcis28t_chip1_filtered_bincounts2.txt",row.names = F)




#----bcis28T-chip2-----#####
met_path <- c("./map_seg_output/bcis28t_chip2")
bcis28t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip2test <- findNormalCell(bcis28t_chip2)

pdf("./figures/bcis28t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip2test1 <- bcis28t_chip2test[, bcis28t_chip2test@colData$is_normal == "TRUE"]
bcis28t_chip2test2 <- bcis28t_chip2test[, bcis28t_chip2test@colData$is_normal == "FALSE"]

bcis28t_chip2test2 <- filterCells(bcis28t_chip2test2, resolution = 0.7)
plotHeatmap(bcis28t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip2test2 <- bcis28t_chip2test2[,bcis28t_chip2test2@colData$filtered == "kept"]
bcis28t_chip2test1@colData$filter_corr_value <- 0
bcis28t_chip2test1@colData$filtered <- "kept"
bcis28t_chip2test1@colData$filter_cell <- "diploid"
bcis28t_chip2test2@colData$filter_cell <- "aneuploid"
bcis28t_chip2 <- cbind(bcis28t_chip2test1, bcis28t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip2,'bin_counts')), 
            "./metrics/bcis28t_chip2_filtered_bincounts2.txt",row.names = F)


#----bcis28T-chip3-----#####
met_path <- c("./map_seg_output/bcis28t_chip3")
bcis28t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip3test <- findNormalCell(bcis28t_chip3)

pdf("./figures/bcis28t_chip3_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip3test1 <- bcis28t_chip3test[, bcis28t_chip3test@colData$is_normal == "TRUE"]
bcis28t_chip3test2 <- bcis28t_chip3test[, bcis28t_chip3test@colData$is_normal == "FALSE"]

bcis28t_chip3test2 <- filterCells(bcis28t_chip3test2, resolution = 0.7)
plotHeatmap(bcis28t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip3test2 <- bcis28t_chip3test2[,bcis28t_chip3test2@colData$filtered == "kept"]
bcis28t_chip3test1@colData$filter_corr_value <- 0
bcis28t_chip3test1@colData$filtered <- "kept"
bcis28t_chip3test1@colData$filter_cell <- "diploid"
bcis28t_chip3test2@colData$filter_cell <- "aneuploid"
bcis28t_chip3 <- cbind(bcis28t_chip3test1, bcis28t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip3,'bin_counts')), 
            "./metrics/bcis28t_chip3_filtered_bincounts2.txt",row.names = F)

































#----bcis28T-chip4-----#####
met_path <- c("./map_seg_output/bcis28t_chip4")
bcis28t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip4test <- findNormalCell(bcis28t_chip4)

pdf("./figures/bcis28t_chip4_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip4test1 <- bcis28t_chip4test[, bcis28t_chip4test@colData$is_normal == "TRUE"]
bcis28t_chip4test2 <- bcis28t_chip4test[, bcis28t_chip4test@colData$is_normal == "FALSE"]

bcis28t_chip4test2 <- filterCells(bcis28t_chip4test2, resolution = 0.7)
plotHeatmap(bcis28t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip4test2 <- bcis28t_chip4test2[,bcis28t_chip4test2@colData$filtered == "kept"]
bcis28t_chip4test1@colData$filter_corr_value <- 0
bcis28t_chip4test1@colData$filtered <- "kept"
bcis28t_chip4test1@colData$filter_cell <- "diploid"
bcis28t_chip4test2@colData$filter_cell <- "aneuploid"
bcis28t_chip4 <- cbind(bcis28t_chip4test1, bcis28t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip4,'bin_counts')), 
            "./metrics/bcis28t_chip4_filtered_bincounts2.txt",row.names = F)




#----ecis48T-chip1-----#####
met_path <- c("./map_seg_output/ecis48t_chip1")
ecis48t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis48t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip1test <- findNormalCell(ecis48t_chip1)

pdf("./figures/ecis48t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis48t_chip1test1 <- ecis48t_chip1test[, ecis48t_chip1test@colData$is_normal == "TRUE"]
ecis48t_chip1test2 <- ecis48t_chip1test[, ecis48t_chip1test@colData$is_normal == "FALSE"]

ecis48t_chip1test2 <- filterCells(ecis48t_chip1test2, resolution = 0.7)
plotHeatmap(ecis48t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis48t_chip1test2 <- ecis48t_chip1test2[,ecis48t_chip1test2@colData$filtered == "kept"]
ecis48t_chip1test1@colData$filter_corr_value <- 0
ecis48t_chip1test1@colData$filtered <- "kept"
ecis48t_chip1test1@colData$filter_cell <- "diploid"
ecis48t_chip1test2@colData$filter_cell <- "aneuploid"
ecis48t_chip1 <- cbind(ecis48t_chip1test1, ecis48t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip1,'bin_counts')), 
            "./metrics/ecis48t_chip1_filtered_bincounts2.txt",row.names = F)




#----ecis48T-chip2-----#####
met_path <- c("./map_seg_output/ecis48t_chip2")
ecis48t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis48t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip2test <- findNormalCell(ecis48t_chip2)

pdf("./figures/ecis48t_chip2_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis48t_chip2test1 <- ecis48t_chip2test[, ecis48t_chip2test@colData$is_normal == "TRUE"]
ecis48t_chip2test2 <- ecis48t_chip2test[, ecis48t_chip2test@colData$is_normal == "FALSE"]

ecis48t_chip2test2 <- filterCells(ecis48t_chip2test2, resolution = 0.7)
plotHeatmap(ecis48t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis48t_chip2test2 <- ecis48t_chip2test2[,ecis48t_chip2test2@colData$filtered == "kept"]
ecis48t_chip2test1@colData$filter_corr_value <- 0
ecis48t_chip2test1@colData$filtered <- "kept"
ecis48t_chip2test1@colData$filter_cell <- "diploid"
ecis48t_chip2test2@colData$filter_cell <- "aneuploid"
ecis48t_chip2 <- cbind(ecis48t_chip2test1, ecis48t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip2,'bin_counts')), 
            "./metrics/ecis48t_chip2_filtered_bincounts2.txt",row.names = F)




#----save non-aneuplody cells---######
pro_name <- c("ecis36t_chip1", "ecis36t_chip2","ecis25t_chip1","ecis25t_chip2","ecis25t_chip3", "bcis13t_chip1", "bcis13t_chip2",
              "ecis44t_chip1", "ecis44t_chip2","ecis44t_chip3","ecis44t_chip4","ecis44t_chip5","ecis44t_chip4",
              "bcis19t_chip1", "bcis19t_chip2", "bcis19t_chip3", "bcis19t_chip4", "bcis28t_chip1", "bcis28t_chip2", 
              "bcis28t_chip3", "bcis28t_chip4", "ecis48t_chip1", "ecis48t_chip2")
for (i in pro_name) {
  # i <- "ecis36t_chip1"
  print(paste0("Now is runnig: ", i))
  met_path <- paste0("./map_seg_output/", i)
  my_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
    dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
  my_obj <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
  my_obj_test <- findNormalCell(my_obj)
  
  my_normal <- my_obj_test@colData %>% as.data.frame() %>% dplyr::filter(is_normal)
  write.csv(my_normal, paste0("./metrics/", i, "_non_aneuplod_cells2.csv"), row.names = F)
}


#######---0.75---####
#----ECIS36T-chip1-----#####
met_path <- c("./map_seg_output/ecis36t_chip1")
ecis36t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip1test <- findNormalCell(ecis36t_chip1)

pdf("./figures/ecis36t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis36t_chip1test1 <- ecis36t_chip1test[, ecis36t_chip1test@colData$is_normal == "TRUE"]
ecis36t_chip1test2 <- ecis36t_chip1test[, ecis36t_chip1test@colData$is_normal == "FALSE"]

ecis36t_chip1test2 <- filterCells(ecis36t_chip1test2, resolution = 0.75)
plotHeatmap(ecis36t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis36t_chip1test2 <- ecis36t_chip1test2[,ecis36t_chip1test2@colData$filtered == "kept"]
ecis36t_chip1test1@colData$filter_corr_value <- 0
ecis36t_chip1test1@colData$filtered <- "kept"
ecis36t_chip1test1@colData$filter_cell <- "diploid"
ecis36t_chip1test2@colData$filter_cell <- "aneuploid"
ecis36t_chip1 <- cbind(ecis36t_chip1test1, ecis36t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip1,'bin_counts')), 
            "./metrics/ecis36t_chip1_filtered_bincounts3.txt",row.names = F)




#----ECIS36T-chip2-----#####
met_path <- c("./map_seg_output/ecis36t_chip2")
ecis36t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip2test <- findNormalCell(ecis36t_chip2)

pdf("./figures/ecis36t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis36t_chip2test1 <- ecis36t_chip2test[, ecis36t_chip2test@colData$is_normal == "TRUE"]
ecis36t_chip2test2 <- ecis36t_chip2test[, ecis36t_chip2test@colData$is_normal == "FALSE"]

ecis36t_chip2test2 <- filterCells(ecis36t_chip2test2, resolution = 0.75)
plotHeatmap(ecis36t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis36t_chip2test2 <- ecis36t_chip2test2[,ecis36t_chip2test2@colData$filtered == "kept"]
ecis36t_chip2test1@colData$filter_corr_value <- 0
ecis36t_chip2test1@colData$filtered <- "kept"
ecis36t_chip2test1@colData$filter_cell <- "diploid"
ecis36t_chip2test2@colData$filter_cell <- "aneuploid"
ecis36t_chip2 <- cbind(ecis36t_chip2test1, ecis36t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip2,'bin_counts')), 
            "./metrics/ecis36t_chip2_filtered_bincounts3.txt",row.names = F)




#----ecis25T-chip1-----#####
met_path <- c("./map_seg_output/ecis25t_chip1")
ecis25t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip1test <- findNormalCell(ecis25t_chip1)

pdf("./figures/ecis25t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip1test1 <- ecis25t_chip1test[, ecis25t_chip1test@colData$is_normal == "TRUE"]
ecis25t_chip1test2 <- ecis25t_chip1test[, ecis25t_chip1test@colData$is_normal == "FALSE"]

ecis25t_chip1test2 <- filterCells(ecis25t_chip1test2, resolution = 0.75)
plotHeatmap(ecis25t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip1test2 <- ecis25t_chip1test2[,ecis25t_chip1test2@colData$filtered == "kept"]
ecis25t_chip1test1@colData$filter_corr_value <- 0
ecis25t_chip1test1@colData$filtered <- "kept"
ecis25t_chip1test1@colData$filter_cell <- "diploid"
ecis25t_chip1test2@colData$filter_cell <- "aneuploid"
ecis25t_chip1 <- cbind(ecis25t_chip1test1, ecis25t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip1,'bin_counts')), 
            "./metrics/ecis25t_chip1_filtered_bincounts3.txt",row.names = F)




#----ecis25T-chip2-----#####
met_path <- c("./map_seg_output/ecis25t_chip2")
ecis25t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip2test <- findNormalCell(ecis25t_chip2)

pdf("./figures/ecis25t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip2test1 <- ecis25t_chip2test[, ecis25t_chip2test@colData$is_normal == "TRUE"]
ecis25t_chip2test2 <- ecis25t_chip2test[, ecis25t_chip2test@colData$is_normal == "FALSE"]

ecis25t_chip2test2 <- filterCells(ecis25t_chip2test2, resolution = 0.75)
plotHeatmap(ecis25t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip2test2 <- ecis25t_chip2test2[,ecis25t_chip2test2@colData$filtered == "kept"]
ecis25t_chip2test1@colData$filter_corr_value <- 0
ecis25t_chip2test1@colData$filtered <- "kept"
ecis25t_chip2test1@colData$filter_cell <- "diploid"
ecis25t_chip2test2@colData$filter_cell <- "aneuploid"
ecis25t_chip2 <- cbind(ecis25t_chip2test1, ecis25t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip2,'bin_counts')), 
            "./metrics/ecis25t_chip2_filtered_bincounts3.txt",row.names = F)


#----ecis25T-chip3-----#####
met_path <- c("./map_seg_output/ecis25t_chip3")
ecis25t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip3test <- findNormalCell(ecis25t_chip3)

pdf("./figures/ecis25t_chip3_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip3test1 <- ecis25t_chip3test[, ecis25t_chip3test@colData$is_normal == "TRUE"]
ecis25t_chip3test2 <- ecis25t_chip3test[, ecis25t_chip3test@colData$is_normal == "FALSE"]

ecis25t_chip3test2 <- filterCells(ecis25t_chip3test2, resolution = 0.75)
plotHeatmap(ecis25t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip3test2 <- ecis25t_chip3test2[,ecis25t_chip3test2@colData$filtered == "kept"]
ecis25t_chip3test1@colData$filter_corr_value <- 0
ecis25t_chip3test1@colData$filtered <- "kept"
ecis25t_chip3test1@colData$filter_cell <- "diploid"
ecis25t_chip3test2@colData$filter_cell <- "aneuploid"
ecis25t_chip3 <- cbind(ecis25t_chip3test1, ecis25t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip3,'bin_counts')), 
            "./metrics/ecis25t_chip3_filtered_bincounts3.txt",row.names = F)































#----bcis13T-chip1-----#####
met_path <- c("./map_seg_output/bcis13t_chip1")
bcis13t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis13t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip1test <- findNormalCell(bcis13t_chip1)

pdf("./figures/bcis13t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis13t_chip1test1 <- bcis13t_chip1test[, bcis13t_chip1test@colData$is_normal == "TRUE"]
bcis13t_chip1test2 <- bcis13t_chip1test[, bcis13t_chip1test@colData$is_normal == "FALSE"]

bcis13t_chip1test2 <- filterCells(bcis13t_chip1test2, resolution = 0.75)
plotHeatmap(bcis13t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis13t_chip1test2 <- bcis13t_chip1test2[,bcis13t_chip1test2@colData$filtered == "kept"]
bcis13t_chip1test1@colData$filter_corr_value <- 0
bcis13t_chip1test1@colData$filtered <- "kept"
bcis13t_chip1test1@colData$filter_cell <- "diploid"
bcis13t_chip1test2@colData$filter_cell <- "aneuploid"
bcis13t_chip1 <- cbind(bcis13t_chip1test1, bcis13t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip1,'bin_counts')), 
            "./metrics/bcis13t_chip1_filtered_bincounts3.txt",row.names = F)




#----bcis13T-chip2-----#####
met_path <- c("./map_seg_output/bcis13t_chip2")
bcis13t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis13t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip2test <- findNormalCell(bcis13t_chip2)

pdf("./figures/bcis13t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis13t_chip2test1 <- bcis13t_chip2test[, bcis13t_chip2test@colData$is_normal == "TRUE"]
bcis13t_chip2test2 <- bcis13t_chip2test[, bcis13t_chip2test@colData$is_normal == "FALSE"]

bcis13t_chip2test2 <- filterCells(bcis13t_chip2test2, resolution = 0.75)
plotHeatmap(bcis13t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis13t_chip2test2 <- bcis13t_chip2test2[,bcis13t_chip2test2@colData$filtered == "kept"]
bcis13t_chip2test1@colData$filter_corr_value <- 0
bcis13t_chip2test1@colData$filtered <- "kept"
bcis13t_chip2test1@colData$filter_cell <- "diploid"
bcis13t_chip2test2@colData$filter_cell <- "aneuploid"
bcis13t_chip2 <- cbind(bcis13t_chip2test1, bcis13t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip2,'bin_counts')), 
            "./metrics/bcis13t_chip2_filtered_bincounts3.txt",row.names = F)





#----ecis44T-chip1-----#####
met_path <- c("./map_seg_output/ecis44t_chip1")
ecis44t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip1test <- findNormalCell(ecis44t_chip1)

pdf("./figures/ecis44t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip1test1 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "TRUE"]
ecis44t_chip1test2 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "FALSE"]

ecis44t_chip1test2 <- filterCells(ecis44t_chip1test2, resolution = 0.75)
plotHeatmap(ecis44t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip1test2 <- ecis44t_chip1test2[,ecis44t_chip1test2@colData$filtered == "kept"]
ecis44t_chip1test1@colData$filter_corr_value <- 0
ecis44t_chip1test1@colData$filtered <- "kept"
ecis44t_chip1test1@colData$filter_cell <- "diploid"
ecis44t_chip1test2@colData$filter_cell <- "aneuploid"
ecis44t_chip1 <- cbind(ecis44t_chip1test1, ecis44t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip1,'bin_counts')), 
            "./metrics/ecis44t_chip1_filtered_bincounts3.txt",row.names = F)




#----ecis44T-chip2-----#####
met_path <- c("./map_seg_output/ecis44t_chip2")
ecis44t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip2test <- findNormalCell(ecis44t_chip2)

pdf("./figures/ecis44t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip2test1 <- ecis44t_chip2test[, ecis44t_chip2test@colData$is_normal == "TRUE"]
ecis44t_chip2test2 <- ecis44t_chip2test[, ecis44t_chip2test@colData$is_normal == "FALSE"]

ecis44t_chip2test2 <- filterCells(ecis44t_chip2test2, resolution = 0.75)
plotHeatmap(ecis44t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip2test2 <- ecis44t_chip2test2[,ecis44t_chip2test2@colData$filtered == "kept"]
ecis44t_chip2test1@colData$filter_corr_value <- 0
ecis44t_chip2test1@colData$filtered <- "kept"
ecis44t_chip2test1@colData$filter_cell <- "diploid"
ecis44t_chip2test2@colData$filter_cell <- "aneuploid"
ecis44t_chip2 <- cbind(ecis44t_chip2test1, ecis44t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip2,'bin_counts')), 
            "./metrics/ecis44t_chip2_filtered_bincounts3.txt",row.names = F)


#----ecis44T-chip3-----#####
met_path <- c("./map_seg_output/ecis44t_chip3")
ecis44t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip3test <- findNormalCell(ecis44t_chip3)

pdf("./figures/ecis44t_chip3_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip3test1 <- ecis44t_chip3test[, ecis44t_chip3test@colData$is_normal == "TRUE"]
ecis44t_chip3test2 <- ecis44t_chip3test[, ecis44t_chip3test@colData$is_normal == "FALSE"]

ecis44t_chip3test2 <- filterCells(ecis44t_chip3test2, resolution = 0.75)
plotHeatmap(ecis44t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip3test2 <- ecis44t_chip3test2[,ecis44t_chip3test2@colData$filtered == "kept"]
ecis44t_chip3test1@colData$filter_corr_value <- 0
ecis44t_chip3test1@colData$filtered <- "kept"
ecis44t_chip3test1@colData$filter_cell <- "diploid"
ecis44t_chip3test2@colData$filter_cell <- "aneuploid"
ecis44t_chip3 <- cbind(ecis44t_chip3test1, ecis44t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip3,'bin_counts')), 
            "./metrics/ecis44t_chip3_filtered_bincounts3.txt",row.names = F)

































# #----ecis44T-chip4-----#####
# met_path <- c("./map_seg_output/ecis44t_chip4")
# ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
#   dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
# ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
# ecis44t_chip4test <- findNormalCell(ecis44t_chip4)
# 
# pdf("./figures/ecis44t_chip4_filtered_heatmap3.pdf", height = 8, width = 6)
# plotHeatmap(ecis44t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
#               list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)
# 
# ecis44t_chip4test1 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "TRUE"]
# ecis44t_chip4test2 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "FALSE"]
# 
# ecis44t_chip4test2 <- filterCells(ecis44t_chip4test2, resolution = 0.75)
# plotHeatmap(ecis44t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
#               list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
# dev.off()
# 
# ecis44t_chip4test2 <- ecis44t_chip4test2[,ecis44t_chip4test2@colData$filtered == "kept"]
# ecis44t_chip4test1@colData$filter_corr_value <- 0
# ecis44t_chip4test1@colData$filtered <- "kept"
# ecis44t_chip4test1@colData$filter_cell <- "diploid"
# ecis44t_chip4test2@colData$filter_cell <- "aneuploid"
# ecis44t_chip4 <- cbind(ecis44t_chip4test1, ecis44t_chip4test2)
# 
# bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
# write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
#             "./metrics/ecis44t_chip4_filtered_bincounts3.txt",row.names = F)
# 
# 

#----ecis44T-chip5-----#####
met_path <- c("./map_seg_output/ecis44t_chip5")
ecis44t_chip5_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip5 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip5test <- findNormalCell(ecis44t_chip5)

pdf("./figures/ecis44t_chip5_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip5test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip5test1 <- ecis44t_chip5test[, ecis44t_chip5test@colData$is_normal == "TRUE"]
ecis44t_chip5test2 <- ecis44t_chip5test[, ecis44t_chip5test@colData$is_normal == "FALSE"]

ecis44t_chip5test2 <- filterCells(ecis44t_chip5test2, resolution = 0.75)
plotHeatmap(ecis44t_chip5test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip5test2 <- ecis44t_chip5test2[,ecis44t_chip5test2@colData$filtered == "kept"]
ecis44t_chip5test1@colData$filter_corr_value <- 0
ecis44t_chip5test1@colData$filtered <- "kept"
ecis44t_chip5test1@colData$filter_cell <- "diploid"
ecis44t_chip5test2@colData$filter_cell <- "aneuploid"
ecis44t_chip5 <- cbind(ecis44t_chip5test1, ecis44t_chip5test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip5,'bin_counts')), 
            "./metrics/ecis44t_chip5_filtered_bincounts3.txt",row.names = F)



#----ecis44T-chip4-----#####
met_path <- c("./map_seg_output/ecis44t_chip4")
ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip4test <- findNormalCell(ecis44t_chip4)

pdf("./figures/ecis44t_chip4_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip4test1 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "TRUE"]
ecis44t_chip4test2 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "FALSE"]

ecis44t_chip4test2 <- filterCells(ecis44t_chip4test2, resolution = 0.75)
plotHeatmap(ecis44t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip4test2 <- ecis44t_chip4test2[,ecis44t_chip4test2@colData$filtered == "kept"]
ecis44t_chip4test1@colData$filter_corr_value <- 0
ecis44t_chip4test1@colData$filtered <- "kept"
ecis44t_chip4test1@colData$filter_cell <- "diploid"
ecis44t_chip4test2@colData$filter_cell <- "aneuploid"
ecis44t_chip4 <- cbind(ecis44t_chip4test1, ecis44t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
            "./metrics/ecis44t_chip4_filtered_bincounts3.txt",row.names = F)






#----bcis19T-chip1-----#####
met_path <- c("./map_seg_output/bcis19t_chip1")
bcis19t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip1test <- findNormalCell(bcis19t_chip1)

pdf("./figures/bcis19t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip1test1 <- bcis19t_chip1test[, bcis19t_chip1test@colData$is_normal == "TRUE"]
bcis19t_chip1test2 <- bcis19t_chip1test[, bcis19t_chip1test@colData$is_normal == "FALSE"]

bcis19t_chip1test2 <- filterCells(bcis19t_chip1test2, resolution = 0.75)
plotHeatmap(bcis19t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip1test2 <- bcis19t_chip1test2[,bcis19t_chip1test2@colData$filtered == "kept"]
bcis19t_chip1test1@colData$filter_corr_value <- 0
bcis19t_chip1test1@colData$filtered <- "kept"
bcis19t_chip1test1@colData$filter_cell <- "diploid"
bcis19t_chip1test2@colData$filter_cell <- "aneuploid"
bcis19t_chip1 <- cbind(bcis19t_chip1test1, bcis19t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip1,'bin_counts')), 
            "./metrics/bcis19t_chip1_filtered_bincounts3.txt",row.names = F)




#----bcis19T-chip2-----#####
met_path <- c("./map_seg_output/bcis19t_chip2")
bcis19t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip2test <- findNormalCell(bcis19t_chip2)

pdf("./figures/bcis19t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip2test1 <- bcis19t_chip2test[, bcis19t_chip2test@colData$is_normal == "TRUE"]
bcis19t_chip2test2 <- bcis19t_chip2test[, bcis19t_chip2test@colData$is_normal == "FALSE"]

bcis19t_chip2test2 <- filterCells(bcis19t_chip2test2, resolution = 0.75)
plotHeatmap(bcis19t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip2test2 <- bcis19t_chip2test2[,bcis19t_chip2test2@colData$filtered == "kept"]
bcis19t_chip2test1@colData$filter_corr_value <- 0
bcis19t_chip2test1@colData$filtered <- "kept"
bcis19t_chip2test1@colData$filter_cell <- "diploid"
bcis19t_chip2test2@colData$filter_cell <- "aneuploid"
bcis19t_chip2 <- cbind(bcis19t_chip2test1, bcis19t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip2,'bin_counts')), 
            "./metrics/bcis19t_chip2_filtered_bincounts3.txt",row.names = F)


#----bcis19T-chip3-----#####
met_path <- c("./map_seg_output/bcis19t_chip3")
bcis19t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip3test <- findNormalCell(bcis19t_chip3)

pdf("./figures/bcis19t_chip3_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip3test1 <- bcis19t_chip3test[, bcis19t_chip3test@colData$is_normal == "TRUE"]
bcis19t_chip3test2 <- bcis19t_chip3test[, bcis19t_chip3test@colData$is_normal == "FALSE"]

bcis19t_chip3test2 <- filterCells(bcis19t_chip3test2, resolution = 0.75)
plotHeatmap(bcis19t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip3test2 <- bcis19t_chip3test2[,bcis19t_chip3test2@colData$filtered == "kept"]
bcis19t_chip3test1@colData$filter_corr_value <- 0
bcis19t_chip3test1@colData$filtered <- "kept"
bcis19t_chip3test1@colData$filter_cell <- "diploid"
bcis19t_chip3test2@colData$filter_cell <- "aneuploid"
bcis19t_chip3 <- cbind(bcis19t_chip3test1, bcis19t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip3,'bin_counts')), 
            "./metrics/bcis19t_chip3_filtered_bincounts3.txt",row.names = F)

































#----bcis19T-chip4-----#####
met_path <- c("./map_seg_output/bcis19t_chip4")
bcis19t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip4test <- findNormalCell(bcis19t_chip4)

pdf("./figures/bcis19t_chip4_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip4test1 <- bcis19t_chip4test[, bcis19t_chip4test@colData$is_normal == "TRUE"]
bcis19t_chip4test2 <- bcis19t_chip4test[, bcis19t_chip4test@colData$is_normal == "FALSE"]

bcis19t_chip4test2 <- filterCells(bcis19t_chip4test2, resolution = 0.75)
plotHeatmap(bcis19t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip4test2 <- bcis19t_chip4test2[,bcis19t_chip4test2@colData$filtered == "kept"]
bcis19t_chip4test1@colData$filter_corr_value <- 0
bcis19t_chip4test1@colData$filtered <- "kept"
bcis19t_chip4test1@colData$filter_cell <- "diploid"
bcis19t_chip4test2@colData$filter_cell <- "aneuploid"
bcis19t_chip4 <- cbind(bcis19t_chip4test1, bcis19t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip4,'bin_counts')), 
            "./metrics/bcis19t_chip4_filtered_bincounts3.txt",row.names = F)





#----bcis28T-chip1-----#####
met_path <- c("./map_seg_output/bcis28t_chip1")
bcis28t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip1test <- findNormalCell(bcis28t_chip1)

pdf("./figures/bcis28t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip1test1 <- bcis28t_chip1test[, bcis28t_chip1test@colData$is_normal == "TRUE"]
bcis28t_chip1test2 <- bcis28t_chip1test[, bcis28t_chip1test@colData$is_normal == "FALSE"]

bcis28t_chip1test2 <- filterCells(bcis28t_chip1test2, resolution = 0.75)
plotHeatmap(bcis28t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip1test2 <- bcis28t_chip1test2[,bcis28t_chip1test2@colData$filtered == "kept"]
bcis28t_chip1test1@colData$filter_corr_value <- 0
bcis28t_chip1test1@colData$filtered <- "kept"
bcis28t_chip1test1@colData$filter_cell <- "diploid"
bcis28t_chip1test2@colData$filter_cell <- "aneuploid"
bcis28t_chip1 <- cbind(bcis28t_chip1test1, bcis28t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip1,'bin_counts')), 
            "./metrics/bcis28t_chip1_filtered_bincounts3.txt",row.names = F)




#----bcis28T-chip2-----#####
met_path <- c("./map_seg_output/bcis28t_chip2")
bcis28t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip2test <- findNormalCell(bcis28t_chip2)

pdf("./figures/bcis28t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip2test1 <- bcis28t_chip2test[, bcis28t_chip2test@colData$is_normal == "TRUE"]
bcis28t_chip2test2 <- bcis28t_chip2test[, bcis28t_chip2test@colData$is_normal == "FALSE"]

bcis28t_chip2test2 <- filterCells(bcis28t_chip2test2, resolution = 0.75)
plotHeatmap(bcis28t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip2test2 <- bcis28t_chip2test2[,bcis28t_chip2test2@colData$filtered == "kept"]
bcis28t_chip2test1@colData$filter_corr_value <- 0
bcis28t_chip2test1@colData$filtered <- "kept"
bcis28t_chip2test1@colData$filter_cell <- "diploid"
bcis28t_chip2test2@colData$filter_cell <- "aneuploid"
bcis28t_chip2 <- cbind(bcis28t_chip2test1, bcis28t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip2,'bin_counts')), 
            "./metrics/bcis28t_chip2_filtered_bincounts3.txt",row.names = F)


#----bcis28T-chip3-----#####
met_path <- c("./map_seg_output/bcis28t_chip3")
bcis28t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip3test <- findNormalCell(bcis28t_chip3)

pdf("./figures/bcis28t_chip3_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip3test1 <- bcis28t_chip3test[, bcis28t_chip3test@colData$is_normal == "TRUE"]
bcis28t_chip3test2 <- bcis28t_chip3test[, bcis28t_chip3test@colData$is_normal == "FALSE"]

bcis28t_chip3test2 <- filterCells(bcis28t_chip3test2, resolution = 0.75)
plotHeatmap(bcis28t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip3test2 <- bcis28t_chip3test2[,bcis28t_chip3test2@colData$filtered == "kept"]
bcis28t_chip3test1@colData$filter_corr_value <- 0
bcis28t_chip3test1@colData$filtered <- "kept"
bcis28t_chip3test1@colData$filter_cell <- "diploid"
bcis28t_chip3test2@colData$filter_cell <- "aneuploid"
bcis28t_chip3 <- cbind(bcis28t_chip3test1, bcis28t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip3,'bin_counts')), 
            "./metrics/bcis28t_chip3_filtered_bincounts3.txt",row.names = F)

































#----bcis28T-chip4-----#####
met_path <- c("./map_seg_output/bcis28t_chip4")
bcis28t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip4test <- findNormalCell(bcis28t_chip4)

pdf("./figures/bcis28t_chip4_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip4test1 <- bcis28t_chip4test[, bcis28t_chip4test@colData$is_normal == "TRUE"]
bcis28t_chip4test2 <- bcis28t_chip4test[, bcis28t_chip4test@colData$is_normal == "FALSE"]

bcis28t_chip4test2 <- filterCells(bcis28t_chip4test2, resolution = 0.75)
plotHeatmap(bcis28t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip4test2 <- bcis28t_chip4test2[,bcis28t_chip4test2@colData$filtered == "kept"]
bcis28t_chip4test1@colData$filter_corr_value <- 0
bcis28t_chip4test1@colData$filtered <- "kept"
bcis28t_chip4test1@colData$filter_cell <- "diploid"
bcis28t_chip4test2@colData$filter_cell <- "aneuploid"
bcis28t_chip4 <- cbind(bcis28t_chip4test1, bcis28t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip4,'bin_counts')), 
            "./metrics/bcis28t_chip4_filtered_bincounts3.txt",row.names = F)




#----ecis48T-chip1-----#####
met_path <- c("./map_seg_output/ecis48t_chip1")
ecis48t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis48t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip1test <- findNormalCell(ecis48t_chip1)

pdf("./figures/ecis48t_chip1_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis48t_chip1test1 <- ecis48t_chip1test[, ecis48t_chip1test@colData$is_normal == "TRUE"]
ecis48t_chip1test2 <- ecis48t_chip1test[, ecis48t_chip1test@colData$is_normal == "FALSE"]

ecis48t_chip1test2 <- filterCells(ecis48t_chip1test2, resolution = 0.75)
plotHeatmap(ecis48t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis48t_chip1test2 <- ecis48t_chip1test2[,ecis48t_chip1test2@colData$filtered == "kept"]
ecis48t_chip1test1@colData$filter_corr_value <- 0
ecis48t_chip1test1@colData$filtered <- "kept"
ecis48t_chip1test1@colData$filter_cell <- "diploid"
ecis48t_chip1test2@colData$filter_cell <- "aneuploid"
ecis48t_chip1 <- cbind(ecis48t_chip1test1, ecis48t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip1,'bin_counts')), 
            "./metrics/ecis48t_chip1_filtered_bincounts3.txt",row.names = F)




#----ecis48T-chip2-----#####
met_path <- c("./map_seg_output/ecis48t_chip2")
ecis48t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis48t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip2test <- findNormalCell(ecis48t_chip2)

pdf("./figures/ecis48t_chip2_filtered_heatmap3.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis48t_chip2test1 <- ecis48t_chip2test[, ecis48t_chip2test@colData$is_normal == "TRUE"]
ecis48t_chip2test2 <- ecis48t_chip2test[, ecis48t_chip2test@colData$is_normal == "FALSE"]

ecis48t_chip2test2 <- filterCells(ecis48t_chip2test2, resolution = 0.7)
plotHeatmap(ecis48t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis48t_chip2test2 <- ecis48t_chip2test2[,ecis48t_chip2test2@colData$filtered == "kept"]
ecis48t_chip2test1@colData$filter_corr_value <- 0
ecis48t_chip2test1@colData$filtered <- "kept"
ecis48t_chip2test1@colData$filter_cell <- "diploid"
ecis48t_chip2test2@colData$filter_cell <- "aneuploid"
ecis48t_chip2 <- cbind(ecis48t_chip2test1, ecis48t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip2,'bin_counts')), 
            "./metrics/ecis48t_chip2_filtered_bincounts3.txt",row.names = F)






#######---0.8---####
#----ECIS36T-chip1-----#####
met_path <- c("./map_seg_output/ecis36t_chip1")
ecis36t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip1test <- findNormalCell(ecis36t_chip1)

pdf("./figures/ecis36t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis36t_chip1test1 <- ecis36t_chip1test[, ecis36t_chip1test@colData$is_normal == "TRUE"]
ecis36t_chip1test2 <- ecis36t_chip1test[, ecis36t_chip1test@colData$is_normal == "FALSE"]

ecis36t_chip1test2 <- filterCells(ecis36t_chip1test2, resolution = 0.8)
plotHeatmap(ecis36t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis36t_chip1test2 <- ecis36t_chip1test2[,ecis36t_chip1test2@colData$filtered == "kept"]
ecis36t_chip1test1@colData$filter_corr_value <- 0
ecis36t_chip1test1@colData$filtered <- "kept"
ecis36t_chip1test1@colData$filter_cell <- "diploid"
ecis36t_chip1test2@colData$filter_cell <- "aneuploid"
ecis36t_chip1 <- cbind(ecis36t_chip1test1, ecis36t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip1,'bin_counts')), 
            "./metrics/ecis36t_chip1_filtered_bincounts4.txt",row.names = F)




#----ECIS36T-chip2-----#####
met_path <- c("./map_seg_output/ecis36t_chip2")
ecis36t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip2test <- findNormalCell(ecis36t_chip2)

pdf("./figures/ecis36t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis36t_chip2test1 <- ecis36t_chip2test[, ecis36t_chip2test@colData$is_normal == "TRUE"]
ecis36t_chip2test2 <- ecis36t_chip2test[, ecis36t_chip2test@colData$is_normal == "FALSE"]

ecis36t_chip2test2 <- filterCells(ecis36t_chip2test2, resolution = 0.8)
plotHeatmap(ecis36t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis36t_chip2test2 <- ecis36t_chip2test2[,ecis36t_chip2test2@colData$filtered == "kept"]
ecis36t_chip2test1@colData$filter_corr_value <- 0
ecis36t_chip2test1@colData$filtered <- "kept"
ecis36t_chip2test1@colData$filter_cell <- "diploid"
ecis36t_chip2test2@colData$filter_cell <- "aneuploid"
ecis36t_chip2 <- cbind(ecis36t_chip2test1, ecis36t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip2,'bin_counts')), 
            "./metrics/ecis36t_chip2_filtered_bincounts4.txt",row.names = F)




#----ecis25T-chip1-----#####
met_path <- c("./map_seg_output/ecis25t_chip1")
ecis25t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip1test <- findNormalCell(ecis25t_chip1)

pdf("./figures/ecis25t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip1test1 <- ecis25t_chip1test[, ecis25t_chip1test@colData$is_normal == "TRUE"]
ecis25t_chip1test2 <- ecis25t_chip1test[, ecis25t_chip1test@colData$is_normal == "FALSE"]

ecis25t_chip1test2 <- filterCells(ecis25t_chip1test2, resolution = 0.8)
plotHeatmap(ecis25t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip1test2 <- ecis25t_chip1test2[,ecis25t_chip1test2@colData$filtered == "kept"]
ecis25t_chip1test1@colData$filter_corr_value <- 0
ecis25t_chip1test1@colData$filtered <- "kept"
ecis25t_chip1test1@colData$filter_cell <- "diploid"
ecis25t_chip1test2@colData$filter_cell <- "aneuploid"
ecis25t_chip1 <- cbind(ecis25t_chip1test1, ecis25t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip1,'bin_counts')), 
            "./metrics/ecis25t_chip1_filtered_bincounts4.txt",row.names = F)




#----ecis25T-chip2-----#####
met_path <- c("./map_seg_output/ecis25t_chip2")
ecis25t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip2test <- findNormalCell(ecis25t_chip2)

pdf("./figures/ecis25t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip2test1 <- ecis25t_chip2test[, ecis25t_chip2test@colData$is_normal == "TRUE"]
ecis25t_chip2test2 <- ecis25t_chip2test[, ecis25t_chip2test@colData$is_normal == "FALSE"]

ecis25t_chip2test2 <- filterCells(ecis25t_chip2test2, resolution = 0.8)
plotHeatmap(ecis25t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip2test2 <- ecis25t_chip2test2[,ecis25t_chip2test2@colData$filtered == "kept"]
ecis25t_chip2test1@colData$filter_corr_value <- 0
ecis25t_chip2test1@colData$filtered <- "kept"
ecis25t_chip2test1@colData$filter_cell <- "diploid"
ecis25t_chip2test2@colData$filter_cell <- "aneuploid"
ecis25t_chip2 <- cbind(ecis25t_chip2test1, ecis25t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip2,'bin_counts')), 
            "./metrics/ecis25t_chip2_filtered_bincounts4.txt",row.names = F)


#----ecis25T-chip3-----#####
met_path <- c("./map_seg_output/ecis25t_chip3")
ecis25t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis25t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip3test <- findNormalCell(ecis25t_chip3)

pdf("./figures/ecis25t_chip3_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis25t_chip3test1 <- ecis25t_chip3test[, ecis25t_chip3test@colData$is_normal == "TRUE"]
ecis25t_chip3test2 <- ecis25t_chip3test[, ecis25t_chip3test@colData$is_normal == "FALSE"]

ecis25t_chip3test2 <- filterCells(ecis25t_chip3test2, resolution = 0.8)
plotHeatmap(ecis25t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis25t_chip3test2 <- ecis25t_chip3test2[,ecis25t_chip3test2@colData$filtered == "kept"]
ecis25t_chip3test1@colData$filter_corr_value <- 0
ecis25t_chip3test1@colData$filtered <- "kept"
ecis25t_chip3test1@colData$filter_cell <- "diploid"
ecis25t_chip3test2@colData$filter_cell <- "aneuploid"
ecis25t_chip3 <- cbind(ecis25t_chip3test1, ecis25t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip3,'bin_counts')), 
            "./metrics/ecis25t_chip3_filtered_bincounts4.txt",row.names = F)































#----bcis13T-chip1-----#####
met_path <- c("./map_seg_output/bcis13t_chip1")
bcis13t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis13t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip1test <- findNormalCell(bcis13t_chip1)

pdf("./figures/bcis13t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis13t_chip1test1 <- bcis13t_chip1test[, bcis13t_chip1test@colData$is_normal == "TRUE"]
bcis13t_chip1test2 <- bcis13t_chip1test[, bcis13t_chip1test@colData$is_normal == "FALSE"]

bcis13t_chip1test2 <- filterCells(bcis13t_chip1test2, resolution = 0.8)
plotHeatmap(bcis13t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis13t_chip1test2 <- bcis13t_chip1test2[,bcis13t_chip1test2@colData$filtered == "kept"]
bcis13t_chip1test1@colData$filter_corr_value <- 0
bcis13t_chip1test1@colData$filtered <- "kept"
bcis13t_chip1test1@colData$filter_cell <- "diploid"
bcis13t_chip1test2@colData$filter_cell <- "aneuploid"
bcis13t_chip1 <- cbind(bcis13t_chip1test1, bcis13t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip1,'bin_counts')), 
            "./metrics/bcis13t_chip1_filtered_bincounts4.txt",row.names = F)




#----bcis13T-chip2-----#####
met_path <- c("./map_seg_output/bcis13t_chip2")
bcis13t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis13t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip2test <- findNormalCell(bcis13t_chip2)

pdf("./figures/bcis13t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis13t_chip2test1 <- bcis13t_chip2test[, bcis13t_chip2test@colData$is_normal == "TRUE"]
bcis13t_chip2test2 <- bcis13t_chip2test[, bcis13t_chip2test@colData$is_normal == "FALSE"]

bcis13t_chip2test2 <- filterCells(bcis13t_chip2test2, resolution = 0.8)
plotHeatmap(bcis13t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis13t_chip2test2 <- bcis13t_chip2test2[,bcis13t_chip2test2@colData$filtered == "kept"]
bcis13t_chip2test1@colData$filter_corr_value <- 0
bcis13t_chip2test1@colData$filtered <- "kept"
bcis13t_chip2test1@colData$filter_cell <- "diploid"
bcis13t_chip2test2@colData$filter_cell <- "aneuploid"
bcis13t_chip2 <- cbind(bcis13t_chip2test1, bcis13t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip2,'bin_counts')), 
            "./metrics/bcis13t_chip2_filtered_bincounts4.txt",row.names = F)





#----ecis44T-chip1-----#####
met_path <- c("./map_seg_output/ecis44t_chip1")
ecis44t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip1test <- findNormalCell(ecis44t_chip1)

pdf("./figures/ecis44t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip1test1 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "TRUE"]
ecis44t_chip1test2 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "FALSE"]

ecis44t_chip1test2 <- filterCells(ecis44t_chip1test2, resolution = 0.8)
plotHeatmap(ecis44t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip1test2 <- ecis44t_chip1test2[,ecis44t_chip1test2@colData$filtered == "kept"]
ecis44t_chip1test1@colData$filter_corr_value <- 0
ecis44t_chip1test1@colData$filtered <- "kept"
ecis44t_chip1test1@colData$filter_cell <- "diploid"
ecis44t_chip1test2@colData$filter_cell <- "aneuploid"
ecis44t_chip1 <- cbind(ecis44t_chip1test1, ecis44t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip1,'bin_counts')), 
            "./metrics/ecis44t_chip1_filtered_bincounts4.txt",row.names = F)




#----ecis44T-chip2-----#####
met_path <- c("./map_seg_output/ecis44t_chip2")
ecis44t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip2test <- findNormalCell(ecis44t_chip2)

pdf("./figures/ecis44t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip2test1 <- ecis44t_chip2test[, ecis44t_chip2test@colData$is_normal == "TRUE"]
ecis44t_chip2test2 <- ecis44t_chip2test[, ecis44t_chip2test@colData$is_normal == "FALSE"]

ecis44t_chip2test2 <- filterCells(ecis44t_chip2test2, resolution = 0.8)
plotHeatmap(ecis44t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip2test2 <- ecis44t_chip2test2[,ecis44t_chip2test2@colData$filtered == "kept"]
ecis44t_chip2test1@colData$filter_corr_value <- 0
ecis44t_chip2test1@colData$filtered <- "kept"
ecis44t_chip2test1@colData$filter_cell <- "diploid"
ecis44t_chip2test2@colData$filter_cell <- "aneuploid"
ecis44t_chip2 <- cbind(ecis44t_chip2test1, ecis44t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip2,'bin_counts')), 
            "./metrics/ecis44t_chip2_filtered_bincounts4.txt",row.names = F)


#----ecis44T-chip3-----#####
met_path <- c("./map_seg_output/ecis44t_chip3")
ecis44t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip3test <- findNormalCell(ecis44t_chip3)

pdf("./figures/ecis44t_chip3_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip3test1 <- ecis44t_chip3test[, ecis44t_chip3test@colData$is_normal == "TRUE"]
ecis44t_chip3test2 <- ecis44t_chip3test[, ecis44t_chip3test@colData$is_normal == "FALSE"]

ecis44t_chip3test2 <- filterCells(ecis44t_chip3test2, resolution = 0.8)
plotHeatmap(ecis44t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip3test2 <- ecis44t_chip3test2[,ecis44t_chip3test2@colData$filtered == "kept"]
ecis44t_chip3test1@colData$filter_corr_value <- 0
ecis44t_chip3test1@colData$filtered <- "kept"
ecis44t_chip3test1@colData$filter_cell <- "diploid"
ecis44t_chip3test2@colData$filter_cell <- "aneuploid"
ecis44t_chip3 <- cbind(ecis44t_chip3test1, ecis44t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip3,'bin_counts')), 
            "./metrics/ecis44t_chip3_filtered_bincounts4.txt",row.names = F)

































# #----ecis44T-chip4-----#####
# met_path <- c("./map_seg_output/ecis44t_chip4")
# ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
#   dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
# ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
# ecis44t_chip4test <- findNormalCell(ecis44t_chip4)
# 
# pdf("./figures/ecis44t_chip4_filtered_heatmap4.pdf", height = 8, width = 6)
# plotHeatmap(ecis44t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
#               list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)
# 
# ecis44t_chip4test1 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "TRUE"]
# ecis44t_chip4test2 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "FALSE"]
# 
# ecis44t_chip4test2 <- filterCells(ecis44t_chip4test2, resolution = 0.8)
# plotHeatmap(ecis44t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
#               list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
# dev.off()
# 
# ecis44t_chip4test2 <- ecis44t_chip4test2[,ecis44t_chip4test2@colData$filtered == "kept"]
# ecis44t_chip4test1@colData$filter_corr_value <- 0
# ecis44t_chip4test1@colData$filtered <- "kept"
# ecis44t_chip4test1@colData$filter_cell <- "diploid"
# ecis44t_chip4test2@colData$filter_cell <- "aneuploid"
# ecis44t_chip4 <- cbind(ecis44t_chip4test1, ecis44t_chip4test2)
# 
# bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
# write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
#             "./metrics/ecis44t_chip4_filtered_bincounts4.txt",row.names = F)
# 
# 

#----ecis44T-chip5-----#####
met_path <- c("./map_seg_output/ecis44t_chip5")
ecis44t_chip5_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip5 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip5test <- findNormalCell(ecis44t_chip5)

pdf("./figures/ecis44t_chip5_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip5test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip5test1 <- ecis44t_chip5test[, ecis44t_chip5test@colData$is_normal == "TRUE"]
ecis44t_chip5test2 <- ecis44t_chip5test[, ecis44t_chip5test@colData$is_normal == "FALSE"]

ecis44t_chip5test2 <- filterCells(ecis44t_chip5test2, resolution = 0.8)
plotHeatmap(ecis44t_chip5test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip5test2 <- ecis44t_chip5test2[,ecis44t_chip5test2@colData$filtered == "kept"]
ecis44t_chip5test1@colData$filter_corr_value <- 0
ecis44t_chip5test1@colData$filtered <- "kept"
ecis44t_chip5test1@colData$filter_cell <- "diploid"
ecis44t_chip5test2@colData$filter_cell <- "aneuploid"
ecis44t_chip5 <- cbind(ecis44t_chip5test1, ecis44t_chip5test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip5,'bin_counts')), 
            "./metrics/ecis44t_chip5_filtered_bincounts4.txt",row.names = F)



#----ecis44T-chip4-----#####
met_path <- c("./map_seg_output/ecis44t_chip4")
ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip4test <- findNormalCell(ecis44t_chip4)

pdf("./figures/ecis44t_chip4_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip4test1 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "TRUE"]
ecis44t_chip4test2 <- ecis44t_chip4test[, ecis44t_chip4test@colData$is_normal == "FALSE"]

ecis44t_chip4test2 <- filterCells(ecis44t_chip4test2, resolution = 0.8)
plotHeatmap(ecis44t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip4test2 <- ecis44t_chip4test2[,ecis44t_chip4test2@colData$filtered == "kept"]
ecis44t_chip4test1@colData$filter_corr_value <- 0
ecis44t_chip4test1@colData$filtered <- "kept"
ecis44t_chip4test1@colData$filter_cell <- "diploid"
ecis44t_chip4test2@colData$filter_cell <- "aneuploid"
ecis44t_chip4 <- cbind(ecis44t_chip4test1, ecis44t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
            "./metrics/ecis44t_chip4_filtered_bincounts4.txt",row.names = F)






#----bcis19T-chip1-----#####
met_path <- c("./map_seg_output/bcis19t_chip1")
bcis19t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip1test <- findNormalCell(bcis19t_chip1)

pdf("./figures/bcis19t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip1test1 <- bcis19t_chip1test[, bcis19t_chip1test@colData$is_normal == "TRUE"]
bcis19t_chip1test2 <- bcis19t_chip1test[, bcis19t_chip1test@colData$is_normal == "FALSE"]

bcis19t_chip1test2 <- filterCells(bcis19t_chip1test2, resolution = 0.8)
plotHeatmap(bcis19t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip1test2 <- bcis19t_chip1test2[,bcis19t_chip1test2@colData$filtered == "kept"]
bcis19t_chip1test1@colData$filter_corr_value <- 0
bcis19t_chip1test1@colData$filtered <- "kept"
bcis19t_chip1test1@colData$filter_cell <- "diploid"
bcis19t_chip1test2@colData$filter_cell <- "aneuploid"
bcis19t_chip1 <- cbind(bcis19t_chip1test1, bcis19t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip1,'bin_counts')), 
            "./metrics/bcis19t_chip1_filtered_bincounts4.txt",row.names = F)




#----bcis19T-chip2-----#####
met_path <- c("./map_seg_output/bcis19t_chip2")
bcis19t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip2test <- findNormalCell(bcis19t_chip2)

pdf("./figures/bcis19t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip2test1 <- bcis19t_chip2test[, bcis19t_chip2test@colData$is_normal == "TRUE"]
bcis19t_chip2test2 <- bcis19t_chip2test[, bcis19t_chip2test@colData$is_normal == "FALSE"]

bcis19t_chip2test2 <- filterCells(bcis19t_chip2test2, resolution = 0.8)
plotHeatmap(bcis19t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip2test2 <- bcis19t_chip2test2[,bcis19t_chip2test2@colData$filtered == "kept"]
bcis19t_chip2test1@colData$filter_corr_value <- 0
bcis19t_chip2test1@colData$filtered <- "kept"
bcis19t_chip2test1@colData$filter_cell <- "diploid"
bcis19t_chip2test2@colData$filter_cell <- "aneuploid"
bcis19t_chip2 <- cbind(bcis19t_chip2test1, bcis19t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip2,'bin_counts')), 
            "./metrics/bcis19t_chip2_filtered_bincounts4.txt",row.names = F)


#----bcis19T-chip3-----#####
met_path <- c("./map_seg_output/bcis19t_chip3")
bcis19t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip3test <- findNormalCell(bcis19t_chip3)

pdf("./figures/bcis19t_chip3_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip3test1 <- bcis19t_chip3test[, bcis19t_chip3test@colData$is_normal == "TRUE"]
bcis19t_chip3test2 <- bcis19t_chip3test[, bcis19t_chip3test@colData$is_normal == "FALSE"]

bcis19t_chip3test2 <- filterCells(bcis19t_chip3test2, resolution = 0.8)
plotHeatmap(bcis19t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip3test2 <- bcis19t_chip3test2[,bcis19t_chip3test2@colData$filtered == "kept"]
bcis19t_chip3test1@colData$filter_corr_value <- 0
bcis19t_chip3test1@colData$filtered <- "kept"
bcis19t_chip3test1@colData$filter_cell <- "diploid"
bcis19t_chip3test2@colData$filter_cell <- "aneuploid"
bcis19t_chip3 <- cbind(bcis19t_chip3test1, bcis19t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip3,'bin_counts')), 
            "./metrics/bcis19t_chip3_filtered_bincounts4.txt",row.names = F)

































#----bcis19T-chip4-----#####
met_path <- c("./map_seg_output/bcis19t_chip4")
bcis19t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis19t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip4test <- findNormalCell(bcis19t_chip4)

pdf("./figures/bcis19t_chip4_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis19t_chip4test1 <- bcis19t_chip4test[, bcis19t_chip4test@colData$is_normal == "TRUE"]
bcis19t_chip4test2 <- bcis19t_chip4test[, bcis19t_chip4test@colData$is_normal == "FALSE"]

bcis19t_chip4test2 <- filterCells(bcis19t_chip4test2, resolution = 0.8)
plotHeatmap(bcis19t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis19t_chip4test2 <- bcis19t_chip4test2[,bcis19t_chip4test2@colData$filtered == "kept"]
bcis19t_chip4test1@colData$filter_corr_value <- 0
bcis19t_chip4test1@colData$filtered <- "kept"
bcis19t_chip4test1@colData$filter_cell <- "diploid"
bcis19t_chip4test2@colData$filter_cell <- "aneuploid"
bcis19t_chip4 <- cbind(bcis19t_chip4test1, bcis19t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip4,'bin_counts')), 
            "./metrics/bcis19t_chip4_filtered_bincounts4.txt",row.names = F)





#----bcis28T-chip1-----#####
met_path <- c("./map_seg_output/bcis28t_chip1")
bcis28t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip1test <- findNormalCell(bcis28t_chip1)

pdf("./figures/bcis28t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip1test1 <- bcis28t_chip1test[, bcis28t_chip1test@colData$is_normal == "TRUE"]
bcis28t_chip1test2 <- bcis28t_chip1test[, bcis28t_chip1test@colData$is_normal == "FALSE"]

bcis28t_chip1test2 <- filterCells(bcis28t_chip1test2, resolution = 0.8)
plotHeatmap(bcis28t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip1test2 <- bcis28t_chip1test2[,bcis28t_chip1test2@colData$filtered == "kept"]
bcis28t_chip1test1@colData$filter_corr_value <- 0
bcis28t_chip1test1@colData$filtered <- "kept"
bcis28t_chip1test1@colData$filter_cell <- "diploid"
bcis28t_chip1test2@colData$filter_cell <- "aneuploid"
bcis28t_chip1 <- cbind(bcis28t_chip1test1, bcis28t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip1,'bin_counts')), 
            "./metrics/bcis28t_chip1_filtered_bincounts4.txt",row.names = F)




#----bcis28T-chip2-----#####
met_path <- c("./map_seg_output/bcis28t_chip2")
bcis28t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip2test <- findNormalCell(bcis28t_chip2)

pdf("./figures/bcis28t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip2test1 <- bcis28t_chip2test[, bcis28t_chip2test@colData$is_normal == "TRUE"]
bcis28t_chip2test2 <- bcis28t_chip2test[, bcis28t_chip2test@colData$is_normal == "FALSE"]

bcis28t_chip2test2 <- filterCells(bcis28t_chip2test2, resolution = 0.8)
plotHeatmap(bcis28t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip2test2 <- bcis28t_chip2test2[,bcis28t_chip2test2@colData$filtered == "kept"]
bcis28t_chip2test1@colData$filter_corr_value <- 0
bcis28t_chip2test1@colData$filtered <- "kept"
bcis28t_chip2test1@colData$filter_cell <- "diploid"
bcis28t_chip2test2@colData$filter_cell <- "aneuploid"
bcis28t_chip2 <- cbind(bcis28t_chip2test1, bcis28t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip2,'bin_counts')), 
            "./metrics/bcis28t_chip2_filtered_bincounts4.txt",row.names = F)


#----bcis28T-chip3-----#####
met_path <- c("./map_seg_output/bcis28t_chip3")
bcis28t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip3test <- findNormalCell(bcis28t_chip3)

pdf("./figures/bcis28t_chip3_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip3test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip3test1 <- bcis28t_chip3test[, bcis28t_chip3test@colData$is_normal == "TRUE"]
bcis28t_chip3test2 <- bcis28t_chip3test[, bcis28t_chip3test@colData$is_normal == "FALSE"]

bcis28t_chip3test2 <- filterCells(bcis28t_chip3test2, resolution = 0.8)
plotHeatmap(bcis28t_chip3test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip3test2 <- bcis28t_chip3test2[,bcis28t_chip3test2@colData$filtered == "kept"]
bcis28t_chip3test1@colData$filter_corr_value <- 0
bcis28t_chip3test1@colData$filtered <- "kept"
bcis28t_chip3test1@colData$filter_cell <- "diploid"
bcis28t_chip3test2@colData$filter_cell <- "aneuploid"
bcis28t_chip3 <- cbind(bcis28t_chip3test1, bcis28t_chip3test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip3,'bin_counts')), 
            "./metrics/bcis28t_chip3_filtered_bincounts4.txt",row.names = F)

































#----bcis28T-chip4-----#####
met_path <- c("./map_seg_output/bcis28t_chip4")
bcis28t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
bcis28t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip4test <- findNormalCell(bcis28t_chip4)

pdf("./figures/bcis28t_chip4_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip4test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

bcis28t_chip4test1 <- bcis28t_chip4test[, bcis28t_chip4test@colData$is_normal == "TRUE"]
bcis28t_chip4test2 <- bcis28t_chip4test[, bcis28t_chip4test@colData$is_normal == "FALSE"]

bcis28t_chip4test2 <- filterCells(bcis28t_chip4test2, resolution = 0.8)
plotHeatmap(bcis28t_chip4test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

bcis28t_chip4test2 <- bcis28t_chip4test2[,bcis28t_chip4test2@colData$filtered == "kept"]
bcis28t_chip4test1@colData$filter_corr_value <- 0
bcis28t_chip4test1@colData$filtered <- "kept"
bcis28t_chip4test1@colData$filter_cell <- "diploid"
bcis28t_chip4test2@colData$filter_cell <- "aneuploid"
bcis28t_chip4 <- cbind(bcis28t_chip4test1, bcis28t_chip4test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip4,'bin_counts')), 
            "./metrics/bcis28t_chip4_filtered_bincounts4.txt",row.names = F)




#----ecis48T-chip1-----#####
met_path <- c("./map_seg_output/ecis48t_chip1")
ecis48t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis48t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip1test <- findNormalCell(ecis48t_chip1)

pdf("./figures/ecis48t_chip1_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis48t_chip1test1 <- ecis48t_chip1test[, ecis48t_chip1test@colData$is_normal == "TRUE"]
ecis48t_chip1test2 <- ecis48t_chip1test[, ecis48t_chip1test@colData$is_normal == "FALSE"]

ecis48t_chip1test2 <- filterCells(ecis48t_chip1test2, resolution = 0.8)
plotHeatmap(ecis48t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis48t_chip1test2 <- ecis48t_chip1test2[,ecis48t_chip1test2@colData$filtered == "kept"]
ecis48t_chip1test1@colData$filter_corr_value <- 0
ecis48t_chip1test1@colData$filtered <- "kept"
ecis48t_chip1test1@colData$filter_cell <- "diploid"
ecis48t_chip1test2@colData$filter_cell <- "aneuploid"
ecis48t_chip1 <- cbind(ecis48t_chip1test1, ecis48t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip1,'bin_counts')), 
            "./metrics/ecis48t_chip1_filtered_bincounts4.txt",row.names = F)




#----ecis48T-chip2-----#####
met_path <- c("./map_seg_output/ecis48t_chip2")
ecis48t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis48t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip2test <- findNormalCell(ecis48t_chip2)

pdf("./figures/ecis48t_chip2_filtered_heatmap4.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip2test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis48t_chip2test1 <- ecis48t_chip2test[, ecis48t_chip2test@colData$is_normal == "TRUE"]
ecis48t_chip2test2 <- ecis48t_chip2test[, ecis48t_chip2test@colData$is_normal == "FALSE"]

ecis48t_chip2test2 <- filterCells(ecis48t_chip2test2, resolution = 0.7)
plotHeatmap(ecis48t_chip2test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis48t_chip2test2 <- ecis48t_chip2test2[,ecis48t_chip2test2@colData$filtered == "kept"]
ecis48t_chip2test1@colData$filter_corr_value <- 0
ecis48t_chip2test1@colData$filtered <- "kept"
ecis48t_chip2test1@colData$filter_cell <- "diploid"
ecis48t_chip2test2@colData$filter_cell <- "aneuploid"
ecis48t_chip2 <- cbind(ecis48t_chip2test1, ecis48t_chip2test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip2,'bin_counts')), 
            "./metrics/ecis48t_chip2_filtered_bincounts4.txt",row.names = F)





#----Read number of each sample----#####

all_basicQC <- data.frame()
pro_name <- c("ecis36t_chip1", "ecis36t_chip2","ecis25t_chip1","ecis25t_chip2","ecis25t_chip3", "bcis13t_chip1", "bcis13t_chip2",
              "ecis44t_chip1", "ecis44t_chip2","ecis44t_chip3","ecis44t_chip4","ecis44t_chip5","ecis44t_chip4",
              "bcis19t_chip1", "bcis19t_chip2", "bcis19t_chip3", "bcis19t_chip4", "bcis28t_chip1", "bcis28t_chip2", 
              "bcis28t_chip3", "bcis28t_chip4", "ecis48t_chip1", "ecis48t_chip2")
for (i in pro_name) {
  # i <- "ecis36t_chip1"
  print(paste0("Now is runnig: ", i))
  my_obj_raw <- get(paste0(i,"test"))@colData
  my_obj <- get(i)@colData
  basic_tmp <- c(i, nrow(my_obj_raw), nrow(my_obj), median(my_obj$reads_total), median(my_obj$reads_assigned_bins), 
                 median(my_obj$percentage_duplicates), median(my_obj$median_bin_count), 
                 length(my_obj$is_normal[my_obj$is_normal == "TRUE"]),
                 length(my_obj$is_normal[my_obj$is_normal == "FALSE"]))
  all_basicQC <- rbind(all_basicQC, basic_tmp)
}
colnames(all_basicQC) <- c("sample","total_cell","cell_passQC","total_reads_median","read_kept_median",
                           "PCR_dup_median","bin_count_median","normal_cell","tumor_cell")
all_basicQC
write.table(all_basicQC, "./metrics/filtering_QC_filter_normal_then_res0.8.txt",row.names = F)
# all_basicQC2 <- read.table("./metrics/filtering_QC_filter_normal_then_res0.8.txt", header = T)

#######################################----OLD-----###################
#----ECIS36T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221105_WDR_DNAlib_reseq_ECIS36_tube1_chip1/data/waferDR_ECIS36_tube1_chip1_DNA_merged/waferDR_ECIS36_tube1_chip1-DNA_merged_200/res_200_k")
met_path <- c("./map_seg_output/ecis36t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis36t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis36t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip1 <- filterCells(ecis36t_chip1, resolution = 0.8)

ecis36t_chip1_metadata <- as.data.frame(colData(ecis36t_chip1))
ecis36t_chip1_metadata_metrics <- left_join(ecis36t_chip1_metadata, ecis36t_chip1_metrics)
write.table(ecis36t_chip1_metadata_metrics,"./metrics/ecis36t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis36t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis36t_chip1 <- ecis36t_chip1[,SummarizedExperiment::colData(ecis36t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip1,'bin_counts')), 
            "./metrics/ecis36t_chip1_filtered_bincounts.txt",row.names = F)

#----ECIS36T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220918_WDR_ECIS36_chip2_DNA_1M_dropDR5pct_gel/data/waferDR_ECIS36_chip2_DNA_1M/waferDR_ECIS36_chip2-DNA_1M_200/res_200_k")
met_path <- c("./map_seg_output/ecis36t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis36t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis36t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis36t_chip2 <- filterCells(ecis36t_chip2, resolution = 0.8)

ecis36t_chip2_metadata <- as.data.frame(colData(ecis36t_chip2))
ecis36t_chip2_metadata_metrics <- left_join(ecis36t_chip2_metadata, ecis36t_chip2_metrics)
write.table(ecis36t_chip2_metadata_metrics,"./metrics/ecis36t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis36t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis36t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis36t_chip2 <- ecis36t_chip2[,SummarizedExperiment::colData(ecis36t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis36t_chip2,'bin_counts')), 
            "./metrics/ecis36t_chip2_filtered_bincounts.txt",row.names = F)

#----ecis25T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20210912_WDR_ECIS25TDFR_ECIS36T-2R/data/waferDR_ECIS25T_DNA/waferDR_ECIS25T_DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis25t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis25t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis25t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip1 <- filterCells(ecis25t_chip1, resolution = 0.8)

ecis25t_chip1_metadata <- as.data.frame(colData(ecis25t_chip1))
ecis25t_chip1_metadata_metrics <- left_join(ecis25t_chip1_metadata, ecis25t_chip1_metrics)
write.table(ecis25t_chip1_metadata_metrics,"./metrics/ecis25t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis25t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis25t_chip1 <- ecis25t_chip1[,SummarizedExperiment::colData(ecis25t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip1,'bin_counts')), 
            "./metrics/ecis25t_chip1_filtered_bincounts.txt",row.names = F)

#----ecis25T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221123_WDR_DNAlib_reseq_ECIS25T_Tube2_Chip1/data/waferDR_ECIS25T_tube2_chip1_DNA/waferDR_ECIS25_tube2_chip1-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis25t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis25t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis25t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip2 <- filterCells(ecis25t_chip2, resolution = 0.8)

ecis25t_chip2_metadata <- as.data.frame(colData(ecis25t_chip2))
ecis25t_chip2_metadata_metrics <- left_join(ecis25t_chip2_metadata, ecis25t_chip2_metrics)
write.table(ecis25t_chip2_metadata_metrics,"./metrics/ecis25t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis25t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis25t_chip2 <- ecis25t_chip2[,SummarizedExperiment::colData(ecis25t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip2,'bin_counts')), 
            "./metrics/ecis25t_chip2_filtered_bincounts.txt",row.names = F)


#----ecis25T-chip3-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221124_WDR_DNAlib_reseq_ECIS25T_Tube2_Chip2/data/waferDR_ECIS25_tube2_chip2_merged/waferDR_ECIS25_tube2_chip2-DNA_merged_200/res_200_k")
met_path <- c("./map_seg_output/ecis25t_chip3")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis25t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis25t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis25t_chip3 <- filterCells(ecis25t_chip3, resolution = 0.8)

ecis25t_chip3_metadata <- as.data.frame(colData(ecis25t_chip3))
ecis25t_chip3_metadata_metrics <- left_join(ecis25t_chip3_metadata, ecis25t_chip3_metrics)
write.table(ecis25t_chip3_metadata_metrics,"./metrics/ecis25t_chip3_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis25t_chip3_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis25t_chip3, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis25t_chip3 <- ecis25t_chip3[,SummarizedExperiment::colData(ecis25t_chip3)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis25t_chip3,'bin_counts')), 
            "./metrics/ecis25t_chip3_filtered_bincounts.txt",row.names = F)


#----bcis13T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221125_WDR_DNAlib_reseq_BCIS13T_Tube1_Chip1/data/waferDR_BCIS13T_tube1_chip1_DNA/waferDR_BCIS13_tube1_chip1-DNA_merged_200/res_200_k")
met_path <- c("./map_seg_output/bcis13t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis13t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis13t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip1 <- filterCells(bcis13t_chip1, resolution = 0.8)

bcis13t_chip1_metadata <- as.data.frame(colData(bcis13t_chip1))
bcis13t_chip1_metadata_metrics <- left_join(bcis13t_chip1_metadata, bcis13t_chip1_metrics)
write.table(bcis13t_chip1_metadata_metrics,"./metrics/bcis13t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis13t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis13t_chip1 <- bcis13t_chip1[,SummarizedExperiment::colData(bcis13t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip1,'bin_counts')), 
            "./metrics/bcis13t_chip1_filtered_bincounts.txt",row.names = F)

#----bcis13T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221126_WDR_DNAlib_reseq_BCIS13T_Tube1_Chip2/data/waferDR_BCIS13T_Tube1_Chip2_DNA/waferDR_BCIS13T_Tube1_Chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis13t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis13t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis13t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis13t_chip2 <- filterCells(bcis13t_chip2, resolution = 0.8)

bcis13t_chip2_metadata <- as.data.frame(colData(bcis13t_chip2))
bcis13t_chip2_metadata_metrics <- left_join(bcis13t_chip2_metadata, bcis13t_chip2_metrics)
write.table(bcis13t_chip2_metadata_metrics,"./metrics/bcis13t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis13t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis13t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis13t_chip2 <- bcis13t_chip2[,SummarizedExperiment::colData(bcis13t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis13t_chip2,'bin_counts')), 
            "./metrics/bcis13t_chip2_filtered_bincounts.txt",row.names = F)



#----ecis44T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20211223_WDR_ECIS44_chip1R_chip2DR/data/waferDR_ECIS44_chip1_DNA/waferDR_ECIS44_chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis44t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis44t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis44t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip1 <- filterCells(ecis44t_chip1, resolution = 0.8)

ecis44t_chip1_metadata <- as.data.frame(colData(ecis44t_chip1))
ecis44t_chip1_metadata_metrics <- left_join(ecis44t_chip1_metadata, ecis44t_chip1_metrics)
write.table(ecis44t_chip1_metadata_metrics,"./metrics/ecis44t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis44t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis44t_chip1 <- ecis44t_chip1[,SummarizedExperiment::colData(ecis44t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip1,'bin_counts')), 
            "./metrics/ecis44t_chip1_filtered_bincounts.txt",row.names = F)

#----ecis44T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221128_WDR_DNAlib_reseq_ECIS44T_Tube2_Chip1/data/waferDR_ECIS44T_Tube2_Chip1_DNA/waferDR_ECIS44T_Tube2_Chip1-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis44t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis44t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis44t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip2 <- filterCells(ecis44t_chip2, resolution = 0.8)

ecis44t_chip2_metadata <- as.data.frame(colData(ecis44t_chip2))
ecis44t_chip2_metadata_metrics <- left_join(ecis44t_chip2_metadata, ecis44t_chip2_metrics)
write.table(ecis44t_chip2_metadata_metrics,"./metrics/ecis44t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis44t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis44t_chip2 <- ecis44t_chip2[,SummarizedExperiment::colData(ecis44t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip2,'bin_counts')), 
            "./metrics/ecis44t_chip2_filtered_bincounts.txt",row.names = F)


#----ecis44T-chip3-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20211231_WDR_ECIS44-72EDTA_chip1R_60PCR1-chip2DR/data/waferDR_ECIS44_chip2_DNA/waferDR_ECIS44_chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis44t_chip3")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis44t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis44t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip3 <- filterCells(ecis44t_chip3, resolution = 0.8)

ecis44t_chip3_metadata <- as.data.frame(colData(ecis44t_chip3))
ecis44t_chip3_metadata_metrics <- left_join(ecis44t_chip3_metadata, ecis44t_chip3_metrics)
write.table(ecis44t_chip3_metadata_metrics,"./metrics/ecis44t_chip3_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis44t_chip3_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip3, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis44t_chip3 <- ecis44t_chip3[,SummarizedExperiment::colData(ecis44t_chip3)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip3,'bin_counts')), 
            "./metrics/ecis44t_chip3_filtered_bincounts.txt",row.names = F)



#----ecis44T-chip4--old-chip4-----#####
# met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220106_WDR_ECIS44_tube3_55RT_chip1R_50RT_chip2R_ECIS44_tube2_chip1D/data/waferDR_ECIS44_Tube2_chip1_DNA/waferDR_ECIS44_Tube2_chip2-DNA_200/res_200_k")
# met_path <- c("./map_seg_output/ecis44t_chip4")
# met_path2 <- paste0(met_path, "/final_result")
# met_path3 <- paste0(met_path, "/metrics")
# system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
# system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))
# 
# ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>%
#   dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads)
# 
# ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
# ecis44t_chip4 <- filterCells(ecis44t_chip4, resolution = 0.8)
# 
# ecis44t_chip4_metadata <- as.data.frame(colData(ecis44t_chip4))
# ecis44t_chip4_metadata_metrics <- left_join(ecis44t_chip4_metadata, ecis44t_chip4_metrics)
# write.table(ecis44t_chip4_metadata_metrics,"./metrics/ecis44t_chip4_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)
# 
# pdf("./figures/ecis44t_chip4_filtered_heatmap.pdf", height = 8, width = 6)
# plotHeatmap(ecis44t_chip4, label = c("filtered"), row_split = "filtered", label_colors =
#               list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
# dev.off()
# 
# 
# ecis44t_chip4 <- ecis44t_chip4[,SummarizedExperiment::colData(ecis44t_chip4)$filtered == "kept"]
# bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
# write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')),
#             "./metrics/ecis44t_chip4_filtered_bincounts.txt",row.names = F)

#----ecis44T-chip5-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221129_WDR_DNAlib_reseq_ECIS44T_Tube3_Chip2/data/waferDR_ECIS44T_tube3_chip2_DNA/waferDR_ECIS44T_Tube3_Chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis44t_chip5")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis44t_chip5_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis44t_chip5 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip5 <- filterCells(ecis44t_chip5, resolution = 0.8)

ecis44t_chip5_metadata <- as.data.frame(colData(ecis44t_chip5))
ecis44t_chip5_metadata_metrics <- left_join(ecis44t_chip5_metadata, ecis44t_chip5_metrics)
write.table(ecis44t_chip5_metadata_metrics,"./metrics/ecis44t_chip5_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis44t_chip5_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip5, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis44t_chip5 <- ecis44t_chip5[,SummarizedExperiment::colData(ecis44t_chip5)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip5,'bin_counts')), 
            "./metrics/ecis44t_chip5_filtered_bincounts.txt",row.names = F)


#----ecis44T-chip4 (old chip4)-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220405_WDR_ECIS44_tube4_chip1DR_chip2R/data/waferDR_ECIS44_tube4_chip1_DNA/waferDR_ECIS44_tube4_chip1-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis44t_chip4")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis44t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis44t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip4 <- filterCells(ecis44t_chip4, resolution = 0.8)

ecis44t_chip4_metadata <- as.data.frame(colData(ecis44t_chip4))
ecis44t_chip4_metadata_metrics <- left_join(ecis44t_chip4_metadata, ecis44t_chip4_metrics)
write.table(ecis44t_chip4_metadata_metrics,"./metrics/ecis44t_chip4_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis44t_chip4_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip4, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis44t_chip4 <- ecis44t_chip4[,SummarizedExperiment::colData(ecis44t_chip4)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip4,'bin_counts')), 
            "./metrics/ecis44t_chip4_filtered_bincounts.txt",row.names = F)



#----bcis19T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220122_WDR_BCIS19_tube1_chip1DR_chip2R_oldTSO/data/waferDR_chip1_DNA/waferDR_BCIS19_Tube1_chip1_oldTSO-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis19t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis19t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis19t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip1 <- filterCells(bcis19t_chip1, resolution = 0.8)

bcis19t_chip1_metadata <- as.data.frame(colData(bcis19t_chip1))
bcis19t_chip1_metadata_metrics <- left_join(bcis19t_chip1_metadata, bcis19t_chip1_metrics)
write.table(bcis19t_chip1_metadata_metrics,"./metrics/bcis19t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis19t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis19t_chip1 <- bcis19t_chip1[,SummarizedExperiment::colData(bcis19t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip1,'bin_counts')), 
            "./metrics/bcis19t_chip1_filtered_bincounts.txt",row.names = F)

#----bcis19T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220129_WDR_BCIS19_tube1_chip2D/data/waferDR_BCIS19_tube1_chip2D/waferDR_BCIS19_Tube1_chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis19t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis19t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis19t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip2 <- filterCells(bcis19t_chip2, resolution = 0.8)

bcis19t_chip2_metadata <- as.data.frame(colData(bcis19t_chip2))
bcis19t_chip2_metadata_metrics <- left_join(bcis19t_chip2_metadata, bcis19t_chip2_metrics)
write.table(bcis19t_chip2_metadata_metrics,"./metrics/bcis19t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis19t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis19t_chip2 <- bcis19t_chip2[,SummarizedExperiment::colData(bcis19t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip2,'bin_counts')), 
            "./metrics/bcis19t_chip2_filtered_bincounts.txt",row.names = F)


#----bcis19T-chip3-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220128_WDR_BCIS19_tube3_chip1DR_chip2R_oldTSO/data/waferDR_BCIS19_tube3_chip1_DNA/waferDR_BCIS19_Tube3_chip1-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis19t_chip3")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis19t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis19t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip3 <- filterCells(bcis19t_chip3, resolution = 0.8)

bcis19t_chip3_metadata <- as.data.frame(colData(bcis19t_chip3))
bcis19t_chip3_metadata_metrics <- left_join(bcis19t_chip3_metadata, bcis19t_chip3_metrics)
write.table(bcis19t_chip3_metadata_metrics,"./metrics/bcis19t_chip3_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis19t_chip3_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip3, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis19t_chip3 <- bcis19t_chip3[,SummarizedExperiment::colData(bcis19t_chip3)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip3,'bin_counts')), 
            "./metrics/bcis19t_chip3_filtered_bincounts.txt",row.names = F)



#----bcis19T-chip4-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220126_WDR_BCIS19_tube3_chip1R_chip2DR/data/waferDR_BCIS19_chip2_DNA/waferDR_BCIS19_Tube3_chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis19t_chip4")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis19t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis19t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis19t_chip4 <- filterCells(bcis19t_chip4, resolution = 0.8)

bcis19t_chip4_metadata <- as.data.frame(colData(bcis19t_chip4))
bcis19t_chip4_metadata_metrics <- left_join(bcis19t_chip4_metadata, bcis19t_chip4_metrics)
write.table(bcis19t_chip4_metadata_metrics,"./metrics/bcis19t_chip4_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis19t_chip4_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis19t_chip4, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis19t_chip4 <- bcis19t_chip4[,SummarizedExperiment::colData(bcis19t_chip4)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis19t_chip4,'bin_counts')), 
            "./metrics/bcis19t_chip4_filtered_bincounts.txt",row.names = F)

#----bcis28T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220507_WDR_BCIS28_chip1DR_chip2R/data/waferDR_BCIS28_chip1_DNA/waferDR_BCIS28_chip1-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis28t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis28t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis28t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip1 <- filterCells(bcis28t_chip1, resolution = 0.8)

bcis28t_chip1_metadata <- as.data.frame(colData(bcis28t_chip1))
bcis28t_chip1_metadata_metrics <- left_join(bcis28t_chip1_metadata, bcis28t_chip1_metrics)
write.table(bcis28t_chip1_metadata_metrics,"./metrics/bcis28t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis28t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis28t_chip1 <- bcis28t_chip1[,SummarizedExperiment::colData(bcis28t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip1,'bin_counts')), 
            "./metrics/bcis28t_chip1_filtered_bincounts.txt",row.names = F)

#----bcis28T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221201_WDR_DNAlib_reseq_BCIS28T_Tube1_Chip2/data/waferDR_BCIS28T_Tube1_Chip2_DNA/waferDR_BCIS28T_Tube1_Chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis28t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis28t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis28t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip2 <- filterCells(bcis28t_chip2, resolution = 0.8)

bcis28t_chip2_metadata <- as.data.frame(colData(bcis28t_chip2))
bcis28t_chip2_metadata_metrics <- left_join(bcis28t_chip2_metadata, bcis28t_chip2_metrics)
write.table(bcis28t_chip2_metadata_metrics,"./metrics/bcis28t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis28t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis28t_chip2 <- bcis28t_chip2[,SummarizedExperiment::colData(bcis28t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip2,'bin_counts')), 
            "./metrics/bcis28t_chip2_filtered_bincounts.txt",row.names = F)


#----bcis28T-chip3-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221203_WDR_DNAlib_reseq_BCIS28T_Tube4_Chip1/data/waferDR_BCIS28T_tube4_chip1_DNA/waferDR_BCIS28T_Tube4_Chip1-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis28t_chip3")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis28t_chip3_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis28t_chip3 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip3 <- filterCells(bcis28t_chip3, resolution = 0.8)

bcis28t_chip3_metadata <- as.data.frame(colData(bcis28t_chip3))
bcis28t_chip3_metadata_metrics <- left_join(bcis28t_chip3_metadata, bcis28t_chip3_metrics)
write.table(bcis28t_chip3_metadata_metrics,"./metrics/bcis28t_chip3_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis28t_chip3_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip3, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis28t_chip3 <- bcis28t_chip3[,SummarizedExperiment::colData(bcis28t_chip3)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip3,'bin_counts')), 
            "./metrics/bcis28t_chip3_filtered_bincounts.txt",row.names = F)



#----bcis28T-chip4-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221205_WDR_DNAlib_reseq_BCIS28T_Tube5_Chip2/data/waferDR_BCIS28T_tube5_chip2_DNA/waferDR_BCIS28T_Tube5_Chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/bcis28t_chip4")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

bcis28t_chip4_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

bcis28t_chip4 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
bcis28t_chip4 <- filterCells(bcis28t_chip4, resolution = 0.8)

bcis28t_chip4_metadata <- as.data.frame(colData(bcis28t_chip4))
bcis28t_chip4_metadata_metrics <- left_join(bcis28t_chip4_metadata, bcis28t_chip4_metrics)
write.table(bcis28t_chip4_metadata_metrics,"./metrics/bcis28t_chip4_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/bcis28t_chip4_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(bcis28t_chip4, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


bcis28t_chip4 <- bcis28t_chip4[,SummarizedExperiment::colData(bcis28t_chip4)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(bcis28t_chip4,'bin_counts')), 
            "./metrics/bcis28t_chip4_filtered_bincounts.txt",row.names = F)



#----ecis48T-chip1-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20220817_WDR_ECIS48_tube1_chip2DR_BCIS31_Chip1R_LNA_TSO/data/waferDR_ECIS48T_tube1_chip2_DNA/waferDR_ECIS48_chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis48t_chip1")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis48t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis48t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip1 <- filterCells(ecis48t_chip1, resolution = 0.8)

ecis48t_chip1_metadata <- as.data.frame(colData(ecis48t_chip1))
ecis48t_chip1_metadata_metrics <- left_join(ecis48t_chip1_metadata, ecis48t_chip1_metrics)
write.table(ecis48t_chip1_metadata_metrics,"./metrics/ecis48t_chip1_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis48t_chip1_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip1, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis48t_chip1 <- ecis48t_chip1[,SummarizedExperiment::colData(ecis48t_chip1)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip1,'bin_counts')), 
            "./metrics/ecis48t_chip1_filtered_bincounts.txt",row.names = F)

#----ecis48T-chip2-----#####
met_path0 <- c("/volumes/USR2/wangkl/wscDR/20221206_WDR_DNAlib_reseq_ECIS48T_Tube2_Chip2/data/waferDR_ECIS48T_tube2_chip2_DNA/waferDR_ECIS48T_Tube2_Chip2-DNA_200/res_200_k")
met_path <- c("./map_seg_output/ecis48t_chip2")
met_path2 <- paste0(met_path, "/final_result")
met_path3 <- paste0(met_path, "/metrics")
system(paste0("mkdir -p ", met_path2, "; mkdir -p ", met_path3))
system(paste0("cp ",met_path0, "/final_result/uber.* ", met_path2, "/; cp ", met_path0, "/metrics/all_stat_metrics.txt ",met_path3,"/"))

ecis48t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 

ecis48t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis48t_chip2 <- filterCells(ecis48t_chip2, resolution = 0.8)

ecis48t_chip2_metadata <- as.data.frame(colData(ecis48t_chip2))
ecis48t_chip2_metadata_metrics <- left_join(ecis48t_chip2_metadata, ecis48t_chip2_metrics)
write.table(ecis48t_chip2_metadata_metrics,"./metrics/ecis48t_chip2_metadata.metrics_newnormal.txt", sep = "\t",row.names = F)

pdf("./figures/ecis48t_chip2_filtered_heatmap.pdf", height = 8, width = 6)
plotHeatmap(ecis48t_chip2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()


ecis48t_chip2 <- ecis48t_chip2[,SummarizedExperiment::colData(ecis48t_chip2)$filtered == "kept"]
bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis48t_chip2,'bin_counts')), 
            "./metrics/ecis48t_chip2_filtered_bincounts.txt",row.names = F)





#----ECIS36T-chip2--Filter resolution test-----#####
met_path <- c("./map_seg_output/ecis36t_chip2")
ecis36t_chip2_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis36t_chip2 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)

pdf("./figures/filter_res_test/ecis36t_chip2_res_0.4-0.7_test_filtered_heatmap.pdf", height = 8, width = 6)
for (i in c(0.4,0.5,0.6,0.7)) {
  ecis36t_chip2test <- filterCells(ecis36t_chip2, resolution = i)
  ecis36t_chip2test_metadata <- as.data.frame(colData(ecis36t_chip2test))
  ecis36t_chip2test_metadata_metrics <- left_join(ecis36t_chip2test_metadata, ecis36t_chip2_metrics)
  print(plotHeatmap(ecis36t_chip2test, label = c("filtered"), row_split = "filtered", label_colors = 
                list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20))
  
}
dev.off()



#----ecis44T-chip1-----#####
met_path <- c("./map_seg_output/ecis44t_chip1")
ecis44t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)

pdf("./figures/filter_res_test/ecis44t_chip1_res_0.2-0.7_test_filtered_heatmap.pdf", height = 8, width = 6)
for (i in c(0.2,0.3,0.4,0.5,0.6,0.7)) {
  ecis44t_chip1test <- filterCells(ecis44t_chip1, resolution = i)
  ecis44t_chip1test_metadata <- as.data.frame(colData(ecis44t_chip1test))
  ecis44t_chip1test_metadata_metrics <- left_join(ecis44t_chip1test_metadata, ecis44t_chip1_metrics)
  print(plotHeatmap(ecis44t_chip1test, label = c("filtered"), row_split = "filtered", label_colors = 
                      list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20))
  
}
dev.off()


#----ecis44T-chip1-breakpoints----#####
met_path <- c("./map_seg_output/ecis44t_chip1")
ecis44t_chip1_metrics <- read.table(paste0(met_path, "/metrics/all_stat_metrics.txt"), sep = "\t", header = T) %>% 
  dplyr::rename(sample = "Sample.Name") %>% mutate(dups_percentage = DupsRemoved/TotalReads) 
ecis44t_chip1 <- readVarbin(met_path, remove_Y = TRUE, clean_names = FALSE)
ecis44t_chip1test <- findNormalCell(ecis44t_chip1)

pdf("./figures/ecis44t_chip1_filtered_heatmap2.pdf", height = 8, width = 6)
plotHeatmap(ecis44t_chip1test, label = c("is_normal"), row_split = "is_normal", label_colors =
              list(filtered = c("FALSE" = "#DA614D", "TURE" = "#5F917A")), n_threads = 20)

ecis44t_chip1test1 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "TRUE"]
ecis44t_chip1test2 <- ecis44t_chip1test[, ecis44t_chip1test@colData$is_normal == "FALSE"]

ecis44t_chip1test2 <- filterCells(ecis44t_chip1test2, resolution = 0.7)
plotHeatmap(ecis44t_chip1test2, label = c("filtered"), row_split = "filtered", label_colors = 
              list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
dev.off()

ecis44t_chip1test2 <- ecis44t_chip1test2[,ecis44t_chip1test2@colData$filtered == "kept"]
ecis44t_chip1test1@colData$filter_corr_value <- 0
ecis44t_chip1test1@colData$filtered <- "kept"
ecis44t_chip1test1@colData$filter_cell <- "diploid"
ecis44t_chip1test2@colData$filter_cell <- "aneuploid"
ecis44t_chip1 <- cbind(ecis44t_chip1test1, ecis44t_chip1test2)

bin_coords2 <- bin_coords %>% dplyr::filter(chrom != 24)
write.table(cbind(bin_coords2,assay(ecis44t_chip1,'bin_counts')), 
            "./metrics/ecis44t_chip1_filtered_bincounts2.txt",row.names = F)





# ecis44t_chip1test <- countBreakpoints(ecis44t_chip1)
# plotHeatmap(ecis44t_chip1test, label = c("filtered"), row_split = "filtered", label_colors = 
#               list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
# 
# 
# ecis44t_chip1test@colData$breakpoint_filter <- ifelse(ecis44t_chip1test@colData$breakpoint_count <= 25, "kept", "removed")
# 
# 
# 
# 
# # ecis44t_chip1test2 <- filterCells(ecis44t_chip1, resolution = 0.3)
# ggplot(as.data.frame(ecis44t_chip1test@colData), aes(breakpoint_count)) + geom_histogram()
# plotHeatmap(ecis44t_chip1test, label = c("breakpoint_filter"), row_split = "breakpoint_filter", label_colors = 
#               list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20)
# 
# pdf("./figures/filter_res_test/ecis44t_chip1_res_0.2-0.7_test_filtered_heatmap.pdf", height = 8, width = 6)
# for (i in c(0.2,0.3,0.4,0.5,0.6,0.7)) {
#   ecis44t_chip1test <- filterCells(ecis44t_chip1, resolution = i)
#   ecis44t_chip1test_metadata <- as.data.frame(colData(ecis44t_chip1test))
#   ecis44t_chip1test_metadata_metrics <- left_join(ecis44t_chip1test_metadata, ecis44t_chip1_metrics)
#   print(plotHeatmap(ecis44t_chip1test, label = c("filtered"), row_split = "filtered", label_colors = 
#                       list(filtered = c("removed" = "#DA614D", "kept" = "#5F917A")), n_threads = 20))
#   
# }
# dev.off()